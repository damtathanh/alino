This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
migrations/
  001_cleanup_profiles.sql
public/
  logo/
    logo.png
src/
  components/
    dashboard/
      DashboardLayout.tsx
      NotificationModal.tsx
    layout/
      Footer.tsx
      Header.tsx
      UserMenu.tsx
    AuthGate.tsx
    AvatarUpload.tsx
    ScrollToTop.tsx
    Toast.tsx
  hooks/
    useAuth.ts
    useProfile.ts
  lib/
    supabase.ts
  pages/
    AppGate.tsx
    BrandDashboard.tsx
    ComingSoonPage.tsx
    CreatorDashboard.tsx
    Dashboard.tsx
    DashboardHome.tsx
    LandingPage.tsx
    LoginPage.tsx
    NotificationsPage.tsx
    OnboardingPage.tsx
    ProfilePage.tsx
    RolePage.tsx
    SettingsPage.tsx
    SignupPage.tsx
    VerifyEmailPage.tsx
  types/
    profile.ts
  utils/
    cropImage.ts
  App.tsx
  index.css
  main.tsx
  router.tsx
  vite-env.d.ts
supabase/
  migrations/
    001_create_profiles.sql
.env.example
.gitignore
index.html
MIGRATION_GUIDE.md
package.json
postcss.config.cjs
PROFILES_IMPLEMENTATION.md
README_VITE.md
README.md
tailwind.config.js
TECHNICAL_SUMMARY.md
tsconfig.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/components/dashboard/DashboardLayout.tsx">
import { Link, useLocation } from 'react-router-dom'
import { 
  FaTh, 
  FaUser, 
  FaDollarSign, 
  FaLightbulb, 
  FaFileAlt, 
  FaCheckCircle, 
  FaChartBar,
  FaCog,
  FaSignOutAlt,
} from 'react-icons/fa'
import { useAuth } from '../../hooks/useAuth'
import { useProfile } from '../../hooks/useProfile'

interface DashboardLayoutProps {
  children: React.ReactNode
}

export default function DashboardLayout({ children }: DashboardLayoutProps) {
  const location = useLocation()
  const { session, signOut } = useAuth()
  const { profile } = useProfile(session?.user?.id, !!session)

  const sidebarItems = [
    { path: '/dashboard', label: 'Bảng điều khiển', icon: FaTh },
    { path: '/dashboard/profile-public', label: 'Hồ sơ công khai', icon: FaUser },
    { path: '/dashboard/services', label: 'Dịch vụ & Bảng giá', icon: FaDollarSign },
    { path: '/dashboard/opportunities', label: 'Cơ hội', icon: FaLightbulb },
    { path: '/dashboard/proposals', label: 'Đề xuất', icon: FaFileAlt },
    { path: '/dashboard/workspace', label: 'Trung tâm làm việc', icon: FaCheckCircle },
    { path: '/dashboard/analytics', label: 'Phân tích', icon: FaChartBar },
  ]

  const isActive = (path: string) => {
    if (path === '/dashboard') {
      return location.pathname === '/dashboard'
    }
    return location.pathname.startsWith(path)
  }

  return (
    <div className="min-h-screen bg-gray-50 pt-20">
      <div className="flex">
        {/* Sidebar */}
        <aside className="fixed left-0 top-20 bottom-0 w-64 bg-white border-r border-gray-200 overflow-y-auto">
          <div className="p-4">
            {/* Navigation Items */}
            <nav className="space-y-1">
              {sidebarItems.map((item) => {
                const Icon = item.icon
                const active = isActive(item.path)

                return (
                  <Link
                    key={item.path}
                    to={item.path}
                    className={`
                      flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors
                      ${active 
                        ? 'bg-gradient-to-r from-[#6366F1] to-[#EC4899] text-white' 
                        : 'text-gray-700 hover:bg-gray-100'
                      }
                    `}
                  >
                    <Icon className="w-5 h-5" />
                    <span>{item.label}</span>
                  </Link>
                )
              })}
            </nav>

            {/* Divider */}
            <div className="border-t border-gray-200 my-4" />

            {/* Settings & Logout */}
            <nav className="space-y-1">
              <Link
                to="/settings"
                className={`
                  flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors
                  ${location.pathname === '/settings'
                    ? 'bg-gray-100 text-[#6366F1]'
                    : 'text-gray-700 hover:bg-gray-100'
                  }
                `}
              >
                <FaCog className="w-5 h-5" />
                <span>Cài đặt</span>
              </Link>
              <button
                onClick={async () => {
                  await signOut()
                }}
                className="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition-colors w-full text-left"
              >
                <FaSignOutAlt className="w-5 h-5" />
                <span>Đăng xuất</span>
              </button>
            </nav>
          </div>
        </aside>

        {/* Main Content */}
        <main className="flex-1 ml-64">
          {children}
        </main>
      </div>
    </div>
  )
}
</file>

<file path="src/components/dashboard/NotificationModal.tsx">
import { useState, useEffect } from 'react'
import { FaCheck, FaCheckCircle, FaTimes } from 'react-icons/fa'

// Mock notification data - replace with real API data later
interface Notification {
  id: string
  type: 'proposal' | 'booking' | 'approval' | 'comment' | 'campaign' | 'profile' | 'collaboration'
  avatar: string
  content: string
  time: string
  timeAgo: string
  read: boolean
  ctaLabel: string
  ctaAction?: () => void
  section: 'new' | 'thisWeek' | 'earlier'
}

const MOCK_NOTIFICATIONS: Notification[] = [
  {
    id: '1',
    type: 'proposal',
    avatar: 'https://ui-avatars.com/api/?name=Brand+X&background=6366F1&color=fff',
    content: 'Brand X đã gửi cho bạn một đề xuất mới cho đề xuất Winter Car của họ',
    time: '2025-01-20T10:00:00Z',
    timeAgo: '5 phút trước',
    read: false,
    ctaLabel: 'Xem đề xuất',
    section: 'new'
  },
  {
    id: '2',
    type: 'booking',
    avatar: 'https://ui-avatars.com/api/?name=Sarah+Chen&background=EC4899&color=fff',
    content: 'Sarah Chen đã chấp nhận yêu cầu đặt lịch của bạn cho buổi chụp ảnh',
    time: '2025-01-20T09:00:00Z',
    timeAgo: '1 giờ trước',
    read: false,
    ctaLabel: 'Quản lý lịch',
    section: 'new'
  },
  {
    id: '3',
    type: 'profile',
    avatar: 'https://ui-avatars.com/api/?name=Profile&background=8B5CF6&color=fff',
    content: 'Hồ sơ của bạn đã đạt 1000 lượt xem trong tuần này! Hãy tiếp tục phát huy.',
    time: '2025-01-20T07:00:00Z',
    timeAgo: '3 giờ trước',
    read: false,
    ctaLabel: '',
    section: 'new'
  },
  {
    id: '4',
    type: 'approval',
    avatar: 'https://ui-avatars.com/api/?name=Alpha+Corp&background=6366F1&color=fff',
    content: 'Alpha Corp cần bạn phê duyệt bản nháp mới nhất cho "Project Zenith"',
    time: '2025-01-19T15:00:00Z',
    timeAgo: 'Hôm qua',
    read: true,
    ctaLabel: 'Phê duyệt bản nháp',
    section: 'thisWeek'
  },
  {
    id: '5',
    type: 'comment',
    avatar: 'https://ui-avatars.com/api/?name=Emily+White&background=EC4899&color=fff',
    content: 'Emily White đã bình luận về bản nháp bạn vừa tải lên',
    time: '2025-01-19T10:00:00Z',
    timeAgo: 'Hôm qua',
    read: true,
    ctaLabel: 'Xem bình luận',
    section: 'thisWeek'
  },
  {
    id: '6',
    type: 'campaign',
    avatar: 'https://ui-avatars.com/api/?name=Global+Brands&background=6366F1&color=fff',
    content: 'Global Brands Inc. đã đăng cơ hội chiến dịch mới: "Summer Collec Campaign"',
    time: '2025-01-18T14:00:00Z',
    timeAgo: '2 ngày trước',
    read: true,
    ctaLabel: 'Xem chiến dịch',
    section: 'thisWeek'
  },
  {
    id: '7',
    type: 'approval',
    avatar: 'https://ui-avatars.com/api/?name=Creative+Studio&background=8B5CF6&color=fff',
    content: 'Creative Studio đã phê duyệt sản phẩm của bạn cho "Animated Explainer Project"',
    time: '2025-01-17T11:00:00Z',
    timeAgo: '3 ngày trước',
    read: true,
    ctaLabel: 'Xem thỏa thuận',
    section: 'thisWeek'
  },
  {
    id: '8',
    type: 'collaboration',
    avatar: 'https://ui-avatars.com/api/?name=Jessica+Lee&background=EC4899&color=fff',
    content: 'Jessica Lee đã mời bạn cộng tác trong "Brand Launch Event"',
    time: '2025-01-13T09:00:00Z',
    timeAgo: '1 tuần trước',
    read: true,
    ctaLabel: 'Chấp nhận lời mời',
    section: 'earlier'
  },
]

const FILTER_TABS = [
  { id: 'all', label: 'Tất cả' },
  { id: 'unread', label: 'Chưa đọc' },
  { id: 'proposals', label: 'Đề xuất' },
  { id: 'bookings', label: 'Đặt lịch' },
  { id: 'drafts', label: 'Bản nháp' },
  { id: 'approvals', label: 'Phê duyệt' },
] as const

type FilterTab = typeof FILTER_TABS[number]['id']

interface NotificationModalProps {
  isOpen: boolean
  onClose: () => void
}

export default function NotificationModal({ isOpen, onClose }: NotificationModalProps) {
  const [activeFilter, setActiveFilter] = useState<FilterTab>('all')
  const [notifications, setNotifications] = useState<Notification[]>(MOCK_NOTIFICATIONS)

  // Handle Esc key to close modal
  useEffect(() => {
    if (!isOpen) return

    const handleEscKey = (event: KeyboardEvent) => {
      if (event.key === 'Escape') {
        onClose()
      }
    }

    document.addEventListener('keydown', handleEscKey)
    return () => {
      document.removeEventListener('keydown', handleEscKey)
    }
  }, [isOpen, onClose])

  const unreadCount = notifications.filter(n => !n.read).length

  const filteredNotifications = notifications.filter((notification) => {
    if (activeFilter === 'all') return true
    if (activeFilter === 'unread') return !notification.read
    if (activeFilter === 'proposals') return notification.type === 'proposal'
    if (activeFilter === 'bookings') return notification.type === 'booking'
    if (activeFilter === 'drafts') return notification.type === 'comment'
    if (activeFilter === 'approvals') return notification.type === 'approval'
    return true
  })

  const markAllAsRead = () => {
    setNotifications(prev => prev.map(n => ({ ...n, read: true })))
  }

  const markAsRead = (id: string) => {
    setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n))
  }

  const newNotifications = filteredNotifications.filter(n => n.section === 'new')
  const thisWeekNotifications = filteredNotifications.filter(n => n.section === 'thisWeek')
  const earlierNotifications = filteredNotifications.filter(n => n.section === 'earlier')

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50" onClick={onClose}>
      <div 
        className="bg-white rounded-xl shadow-2xl w-[1000px] h-[80vh] flex flex-col mx-4"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Modal Header - Sticky */}
        <div className="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-xl font-bold text-gray-900">Thông báo</h2>
          <button
            onClick={onClose}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          >
            <FaTimes className="w-5 h-5 text-gray-500" />
          </button>
        </div>

        {/* Filter Tabs - Sticky */}
        <div className="flex items-center gap-2 p-4 border-b border-gray-200 flex-shrink-0 overflow-x-auto">
          {FILTER_TABS.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveFilter(tab.id)}
              className={`
                px-4 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap flex items-center gap-2
                ${activeFilter === tab.id
                  ? 'bg-gradient-to-r from-[#6366F1] to-[#EC4899] text-white'
                  : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50'
                }
              `}
            >
              <span>{tab.label}</span>
              {tab.id === 'unread' && unreadCount > 0 && (
                <span className={`
                  w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold
                  ${activeFilter === tab.id 
                    ? 'bg-white text-[#6366F1]' 
                    : 'bg-[#6366F1] text-white'
                  }
                `}>
                  {unreadCount}
                </span>
              )}
            </button>
          ))}

          {/* Mark all as read button */}
          <button
            onClick={markAllAsRead}
            className="ml-auto flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:text-[#6366F1] transition-colors border-2 border-gray-300 rounded-lg hover:border-[#6366F1] hover:bg-gray-50 active:bg-gray-100 whitespace-nowrap"
          >
            <FaCheckCircle className="w-4 h-4" />
            <span>Đánh dấu tất cả là đã đọc</span>
          </button>
        </div>

        {/* Scrollable Notification List */}
        <div className="flex-1 overflow-y-auto p-4">
          <div className="space-y-6">
            {/* New Section */}
            {newNotifications.length > 0 && (
              <div>
                <h3 className="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wide">Mới</h3>
                <div className="space-y-3">
                  {newNotifications.map((notification) => (
                    <NotificationCard
                      key={notification.id}
                      notification={notification}
                      onMarkAsRead={() => markAsRead(notification.id)}
                    />
                  ))}
                </div>
              </div>
            )}

            {/* This Week Section */}
            {thisWeekNotifications.length > 0 && (
              <div>
                <h3 className="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wide">Tuần này</h3>
                <div className="space-y-3">
                  {thisWeekNotifications.map((notification) => (
                    <NotificationCard
                      key={notification.id}
                      notification={notification}
                      onMarkAsRead={() => markAsRead(notification.id)}
                    />
                  ))}
                </div>
              </div>
            )}

            {/* Earlier Section */}
            {earlierNotifications.length > 0 && (
              <div>
                <h3 className="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wide">Trước đó</h3>
                <div className="space-y-3">
                  {earlierNotifications.map((notification) => (
                    <NotificationCard
                      key={notification.id}
                      notification={notification}
                      onMarkAsRead={() => markAsRead(notification.id)}
                    />
                  ))}
                </div>
              </div>
            )}

            {/* Empty State */}
            {filteredNotifications.length === 0 && (
              <div className="text-center py-12">
                <p className="text-gray-500">Không có thông báo nào</p>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  )
}

interface NotificationCardProps {
  notification: Notification
  onMarkAsRead: () => void
}

function NotificationCard({ notification, onMarkAsRead }: NotificationCardProps) {
  return (
    <div
      className={`
        flex items-start gap-4 p-4 rounded-xl border transition-colors
        ${notification.read 
          ? 'bg-white border-gray-200' 
          : 'bg-blue-50 border-blue-200'
        }
        hover:shadow-md
      `}
    >
      {/* Avatar */}
      <img
        src={notification.avatar}
        alt=""
        className="w-12 h-12 rounded-full flex-shrink-0"
      />

      {/* Content */}
      <div className="flex-1 min-w-0">
        <p className={`text-sm ${notification.read ? 'text-gray-700' : 'text-gray-900 font-medium'}`}>
          {notification.content}
        </p>
        <p className="text-xs text-gray-500 mt-1">{notification.timeAgo}</p>
      </div>

      {/* Actions */}
      <div className="flex items-start gap-3 flex-shrink-0">
        {notification.ctaLabel && (
          <button
            onClick={onMarkAsRead}
            className="px-4 py-2 bg-gradient-to-r from-[#6366F1] to-[#EC4899] text-white text-sm font-medium rounded-lg hover:opacity-90 transition-opacity whitespace-nowrap"
          >
            {notification.ctaLabel}
          </button>
        )}
        <button
          onClick={onMarkAsRead}
          className={`
            p-2 rounded-lg transition-colors
            ${notification.read 
              ? 'text-gray-400 hover:bg-gray-100' 
              : 'text-[#6366F1] hover:bg-blue-100'
            }
          `}
          title={notification.read ? 'Đã đọc' : 'Đánh dấu là đã đọc'}
        >
          <FaCheck className="w-4 h-4" />
        </button>
      </div>
    </div>
  )
}
</file>

<file path="src/pages/ComingSoonPage.tsx">
/**
 * Placeholder page for unfinished dashboard features
 * Title and subtitle are shown in Header, this page shows feature content only
 */
export default function ComingSoonPage() {
  return (
    <div className="min-h-screen bg-white">
      <div className="max-w-6xl mx-auto p-8">
        <div className="text-center py-20">
          <p className="text-lg text-gray-600">
            Tính năng đang xây dựng
          </p>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/pages/Dashboard.tsx">
import { useLocation } from 'react-router-dom'
import DashboardLayout from '../components/dashboard/DashboardLayout'
import DashboardHome from './DashboardHome'
import ComingSoonPage from './ComingSoonPage'

/**
 * Unified Dashboard component that works for both Creator and Brand roles.
 * Routes to appropriate page based on current pathname.
 */
export default function Dashboard() {
  const location = useLocation()
  
  // Dashboard home - show greeting
  if (location.pathname === '/dashboard') {
    return (
      <DashboardLayout>
        <DashboardHome />
      </DashboardLayout>
    )
  }
  
  // All other dashboard routes show coming soon
  return (
    <DashboardLayout>
      <ComingSoonPage />
    </DashboardLayout>
  )
}
</file>

<file path="src/pages/DashboardHome.tsx">
/**
 * Dashboard Home page - shown when user clicks "Bảng điều khiển"
 * Title and subtitle are shown in Header, this page contains feature content only
 */
export default function DashboardHome() {
  return (
    <div className="min-h-screen bg-white">
      <div className="max-w-6xl mx-auto p-8">
        {/* Feature content goes here - title/subtitle are in Header */}
      </div>
    </div>
  )
}
</file>

<file path="src/pages/NotificationsPage.tsx">
import { useState } from 'react'
import { FaCheck, FaCheckCircle } from 'react-icons/fa'

// Mock notification data - replace with real API data later
interface Notification {
  id: string
  type: 'proposal' | 'booking' | 'approval' | 'comment' | 'campaign' | 'profile' | 'collaboration'
  avatar: string
  content: string
  time: string
  timeAgo: string
  read: boolean
  ctaLabel: string
  ctaAction?: () => void
  section: 'new' | 'thisWeek' | 'earlier'
}

const MOCK_NOTIFICATIONS: Notification[] = [
  {
    id: '1',
    type: 'proposal',
    avatar: 'https://ui-avatars.com/api/?name=Brand+X&background=6366F1&color=fff',
    content: 'Brand X đã gửi cho bạn một đề xuất mới cho đề xuất Winter Car của họ',
    time: '2025-01-20T10:00:00Z',
    timeAgo: '5 phút trước',
    read: false,
    ctaLabel: 'Xem đề xuất',
    section: 'new'
  },
  {
    id: '2',
    type: 'booking',
    avatar: 'https://ui-avatars.com/api/?name=Sarah+Chen&background=EC4899&color=fff',
    content: 'Sarah Chen đã chấp nhận yêu cầu đặt lịch của bạn cho buổi chụp ảnh',
    time: '2025-01-20T09:00:00Z',
    timeAgo: '1 giờ trước',
    read: false,
    ctaLabel: 'Quản lý lịch',
    section: 'new'
  },
  {
    id: '3',
    type: 'profile',
    avatar: 'https://ui-avatars.com/api/?name=Profile&background=8B5CF6&color=fff',
    content: 'Hồ sơ của bạn đã đạt 1000 lượt xem trong tuần này! Hãy tiếp tục phát huy.',
    time: '2025-01-20T07:00:00Z',
    timeAgo: '3 giờ trước',
    read: false,
    ctaLabel: '',
    section: 'new'
  },
  {
    id: '4',
    type: 'approval',
    avatar: 'https://ui-avatars.com/api/?name=Alpha+Corp&background=6366F1&color=fff',
    content: 'Alpha Corp cần bạn phê duyệt bản nháp mới nhất cho "Project Zenith"',
    time: '2025-01-19T15:00:00Z',
    timeAgo: 'Hôm qua',
    read: true,
    ctaLabel: 'Phê duyệt bản nháp',
    section: 'thisWeek'
  },
  {
    id: '5',
    type: 'comment',
    avatar: 'https://ui-avatars.com/api/?name=Emily+White&background=EC4899&color=fff',
    content: 'Emily White đã bình luận về bản nháp bạn vừa tải lên',
    time: '2025-01-19T10:00:00Z',
    timeAgo: 'Hôm qua',
    read: true,
    ctaLabel: 'Xem bình luận',
    section: 'thisWeek'
  },
  {
    id: '6',
    type: 'campaign',
    avatar: 'https://ui-avatars.com/api/?name=Global+Brands&background=6366F1&color=fff',
    content: 'Global Brands Inc. đã đăng cơ hội chiến dịch mới: "Summer Collec Campaign"',
    time: '2025-01-18T14:00:00Z',
    timeAgo: '2 ngày trước',
    read: true,
    ctaLabel: 'Xem chiến dịch',
    section: 'thisWeek'
  },
  {
    id: '7',
    type: 'approval',
    avatar: 'https://ui-avatars.com/api/?name=Creative+Studio&background=8B5CF6&color=fff',
    content: 'Creative Studio đã phê duyệt sản phẩm của bạn cho "Animated Explainer Project"',
    time: '2025-01-17T11:00:00Z',
    timeAgo: '3 ngày trước',
    read: true,
    ctaLabel: 'Xem thỏa thuận',
    section: 'thisWeek'
  },
  {
    id: '8',
    type: 'collaboration',
    avatar: 'https://ui-avatars.com/api/?name=Jessica+Lee&background=EC4899&color=fff',
    content: 'Jessica Lee đã mời bạn cộng tác trong "Brand Launch Event"',
    time: '2025-01-13T09:00:00Z',
    timeAgo: '1 tuần trước',
    read: true,
    ctaLabel: 'Chấp nhận lời mời',
    section: 'earlier'
  },
]

const FILTER_TABS = [
  { id: 'all', label: 'Tất cả' },
  { id: 'unread', label: 'Chưa đọc' },
  { id: 'proposals', label: 'Đề xuất' },
  { id: 'bookings', label: 'Đặt lịch' },
  { id: 'drafts', label: 'Bản nháp' },
  { id: 'approvals', label: 'Phê duyệt' },
] as const

type FilterTab = typeof FILTER_TABS[number]['id']

export default function NotificationsPage() {
  const [activeFilter, setActiveFilter] = useState<FilterTab>('all')
  const [notifications, setNotifications] = useState<Notification[]>(MOCK_NOTIFICATIONS)

  const unreadCount = notifications.filter(n => !n.read).length

  const filteredNotifications = notifications.filter((notification) => {
    if (activeFilter === 'all') return true
    if (activeFilter === 'unread') return !notification.read
    if (activeFilter === 'proposals') return notification.type === 'proposal'
    if (activeFilter === 'bookings') return notification.type === 'booking'
    if (activeFilter === 'drafts') return notification.type === 'comment'
    if (activeFilter === 'approvals') return notification.type === 'approval'
    return true
  })

  const markAllAsRead = () => {
    setNotifications(prev => prev.map(n => ({ ...n, read: true })))
  }

  const markAsRead = (id: string) => {
    setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n))
  }

  const newNotifications = filteredNotifications.filter(n => n.section === 'new')
  const thisWeekNotifications = filteredNotifications.filter(n => n.section === 'thisWeek')
  const earlierNotifications = filteredNotifications.filter(n => n.section === 'earlier')

  return (
    <div className="min-h-screen bg-white">
      <div className="max-w-6xl mx-auto p-8">
        {/* Header */}
        <div className="mb-6">
          <h1 className="text-3xl font-bold text-gray-900 mb-6">Thông báo</h1>

          {/* Filter Tabs */}
          <div className="flex items-center gap-2 mb-4 flex-wrap">
            {FILTER_TABS.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveFilter(tab.id)}
                className={`
                  px-4 py-2 rounded-full text-sm font-medium transition-colors relative
                  ${activeFilter === tab.id
                    ? 'bg-gradient-to-r from-[#6366F1] to-[#EC4899] text-white'
                    : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50'
                  }
                `}
              >
                {tab.label}
                {tab.id === 'unread' && unreadCount > 0 && (
                  <span className="ml-2 w-5 h-5 bg-white text-[#6366F1] rounded-full flex items-center justify-center text-xs font-bold">
                    {unreadCount}
                  </span>
                )}
              </button>
            ))}

            {/* Mark all as read button */}
            <button
              onClick={markAllAsRead}
              className="ml-auto flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:text-[#6366F1] transition-colors"
            >
              <FaCheckCircle className="w-4 h-4" />
              <span>Đánh dấu tất cả là đã đọc</span>
            </button>
          </div>
        </div>

        {/* Notifications List */}
        <div className="space-y-8">
          {/* New Section */}
          {newNotifications.length > 0 && (
            <div>
              <h2 className="text-sm font-semibold text-gray-500 mb-4 uppercase tracking-wide">Mới</h2>
              <div className="space-y-3">
                {newNotifications.map((notification) => (
                  <NotificationCard
                    key={notification.id}
                    notification={notification}
                    onMarkAsRead={() => markAsRead(notification.id)}
                  />
                ))}
              </div>
            </div>
          )}

          {/* This Week Section */}
          {thisWeekNotifications.length > 0 && (
            <div>
              <h2 className="text-sm font-semibold text-gray-500 mb-4 uppercase tracking-wide">Tuần này</h2>
              <div className="space-y-3">
                {thisWeekNotifications.map((notification) => (
                  <NotificationCard
                    key={notification.id}
                    notification={notification}
                    onMarkAsRead={() => markAsRead(notification.id)}
                  />
                ))}
              </div>
            </div>
          )}

          {/* Earlier Section */}
          {earlierNotifications.length > 0 && (
            <div>
              <h2 className="text-sm font-semibold text-gray-500 mb-4 uppercase tracking-wide">Trước đó</h2>
              <div className="space-y-3">
                {earlierNotifications.map((notification) => (
                  <NotificationCard
                    key={notification.id}
                    notification={notification}
                    onMarkAsRead={() => markAsRead(notification.id)}
                  />
                ))}
              </div>
            </div>
          )}

          {/* Empty State */}
          {filteredNotifications.length === 0 && (
            <div className="text-center py-12">
              <p className="text-gray-500">Không có thông báo nào</p>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

interface NotificationCardProps {
  notification: Notification
  onMarkAsRead: () => void
}

function NotificationCard({ notification, onMarkAsRead }: NotificationCardProps) {
  return (
    <div
      className={`
        flex items-start gap-4 p-4 rounded-xl border transition-colors
        ${notification.read 
          ? 'bg-white border-gray-200' 
          : 'bg-blue-50 border-blue-200'
        }
        hover:shadow-md
      `}
    >
      {/* Avatar */}
      <img
        src={notification.avatar}
        alt=""
        className="w-12 h-12 rounded-full flex-shrink-0"
      />

      {/* Content */}
      <div className="flex-1 min-w-0">
        <p className={`text-sm ${notification.read ? 'text-gray-700' : 'text-gray-900 font-medium'}`}>
          {notification.content}
        </p>
        <p className="text-xs text-gray-500 mt-1">{notification.timeAgo}</p>
      </div>

      {/* Actions */}
      <div className="flex items-start gap-3 flex-shrink-0">
        {notification.ctaLabel && (
          <button
            onClick={onMarkAsRead}
            className="px-4 py-2 bg-gradient-to-r from-[#6366F1] to-[#EC4899] text-white text-sm font-medium rounded-lg hover:opacity-90 transition-opacity whitespace-nowrap"
          >
            {notification.ctaLabel}
          </button>
        )}
        <button
          onClick={onMarkAsRead}
          className={`
            p-2 rounded-lg transition-colors
            ${notification.read 
              ? 'text-gray-400 hover:bg-gray-100' 
              : 'text-[#6366F1] hover:bg-blue-100'
            }
          `}
          title={notification.read ? 'Đã đọc' : 'Đánh dấu là đã đọc'}
        >
          <FaCheck className="w-4 h-4" />
        </button>
      </div>
    </div>
  )
}
</file>

<file path="migrations/001_cleanup_profiles.sql">
-- Migration: Clean up profiles table structure
-- Remove unused columns and ensure proper schema

-- Step 1: Remove unused columns
ALTER TABLE public.profiles
  DROP COLUMN IF EXISTS role_selected_at,
  DROP COLUMN IF EXISTS onboarding_completed_at;

-- Step 2: Ensure all required columns exist with correct types
-- Core fields
ALTER TABLE public.profiles
  ADD COLUMN IF NOT EXISTS display_name TEXT,
  ADD COLUMN IF NOT EXISTS avatar_url TEXT,
  ADD COLUMN IF NOT EXISTS country TEXT,
  ADD COLUMN IF NOT EXISTS city TEXT,
  ADD COLUMN IF NOT EXISTS birth_year INTEGER,
  ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();

-- Creator fields
ALTER TABLE public.profiles
  ADD COLUMN IF NOT EXISTS bio TEXT,
  ADD COLUMN IF NOT EXISTS creator_platforms JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS followers_count INTEGER,
  ADD COLUMN IF NOT EXISTS avg_views INTEGER,
  ADD COLUMN IF NOT EXISTS content_categories JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS success_collaboration_rate INTEGER CHECK (success_collaboration_rate >= 0 AND success_collaboration_rate <= 100),
  ADD COLUMN IF NOT EXISTS preferred_collaboration_type JSONB DEFAULT '[]'::jsonb;

-- Brand fields
ALTER TABLE public.profiles
  ADD COLUMN IF NOT EXISTS company_name TEXT,
  ADD COLUMN IF NOT EXISTS website TEXT,
  ADD COLUMN IF NOT EXISTS industry TEXT,
  ADD COLUMN IF NOT EXISTS company_size TEXT,
  ADD COLUMN IF NOT EXISTS campaign_budget_range TEXT,
  ADD COLUMN IF NOT EXISTS campaign_goal TEXT,
  ADD COLUMN IF NOT EXISTS target_platforms JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS target_creator_size TEXT,
  ADD COLUMN IF NOT EXISTS contact_person_name TEXT,
  ADD COLUMN IF NOT EXISTS contact_person_phone TEXT;

-- Step 3: Remove old columns that are no longer needed
ALTER TABLE public.profiles
  DROP COLUMN IF EXISTS collaboration_expectation,
  DROP COLUMN IF EXISTS collaboration_success_rate,
  DROP COLUMN IF EXISTS budget,
  DROP COLUMN IF EXISTS contact_person_email;

-- Step 4: Create function to upsert profile on first login
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, role, onboarding_completed)
  VALUES (NEW.id, NULL, false)
  ON CONFLICT (id) DO NOTHING;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Step 5: Create trigger (if not exists)
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();

-- Step 6: Update RLS policies
-- Users can read their own profile
DROP POLICY IF EXISTS "Users can read own profile" ON public.profiles;
CREATE POLICY "Users can read own profile"
  ON public.profiles
  FOR SELECT
  USING (auth.uid() = id);

-- Users can update their own profile
DROP POLICY IF EXISTS "Users can update own profile" ON public.profiles;
CREATE POLICY "Users can update own profile"
  ON public.profiles
  FOR UPDATE
  USING (auth.uid() = id);

-- Users can insert their own profile
DROP POLICY IF EXISTS "Users can insert own profile" ON public.profiles;
CREATE POLICY "Users can insert own profile"
  ON public.profiles
  FOR INSERT
  WITH CHECK (auth.uid() = id);

-- Step 7: Ensure updated_at is updated on change
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS update_profiles_updated_at ON public.profiles;
CREATE TRIGGER update_profiles_updated_at
  BEFORE UPDATE ON public.profiles
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();
</file>

<file path="src/components/layout/Footer.tsx">
import { FaFacebook, FaInstagram, FaTiktok, FaYoutube, FaLinkedin, FaPhone, FaEnvelope, FaMapMarkerAlt } from 'react-icons/fa'

export default function Footer() {
  return (
    <footer className="relative pt-20 pb-8 bg-white border-t border-black/5">
      <div className="max-w-7xl mx-auto px-6">
        <div className="grid md:grid-cols-5 gap-12 mb-8">
          <div className="space-y-4">
            <div className="flex items-center gap-3">
              <img
                src="/logo/logo.png"
                alt="ALINO"
                className="w-7 h-7"
              />
              <span className="font-semibold text-lg tracking-tight bg-gradient-to-r from-[#6366F1] to-[#EC4899] bg-clip-text text-transparent">
                ALINO
              </span>
            </div>
            <p className="text-sm text-[#6B7280] leading-relaxed">
              Nền tảng hợp tác cho Creator và Brand chuyên nghiệp.
            </p>
            <div className="flex items-center gap-4 pt-2">
              <a
                href="https://facebook.com"
                target="_blank"
                rel="noopener noreferrer"
                className="text-[#9CA3AF] hover:text-[#1877F2] transition-colors hover:scale-110 transform duration-200"
              >
                <FaFacebook size={20} />
              </a>
              <a
                href="https://instagram.com"
                target="_blank"
                rel="noopener noreferrer"
                className="text-[#9CA3AF] hover:text-[#DD2A7B] transition-colors hover:scale-110 transform duration-200"
              >
                <FaInstagram size={20} />
              </a>
              <a
                href="https://tiktok.com"
                target="_blank"
                rel="noopener noreferrer"
                className="text-[#9CA3AF] hover:text-[#000000] transition-colors hover:scale-110 transform duration-200"
              >
                <FaTiktok size={20} />
              </a>
              <a
                href="https://youtube.com"
                target="_blank"
                rel="noopener noreferrer"
                className="text-[#9CA3AF] hover:text-[#FF0000] transition-colors hover:scale-110 transform duration-200"
              >
                <FaYoutube size={20} />
              </a>
              <a
                href="https://linkedin.com"
                target="_blank"
                rel="noopener noreferrer"
                className="text-[#9CA3AF] hover:text-[#0A66C2] transition-colors hover:scale-110 transform duration-200"
              >
                <FaLinkedin size={20} />
              </a>
            </div>
          </div>

          <div>
            <h4 className="font-semibold text-sm mb-4 tracking-tight">Sản phẩm</h4>
            <ul className="space-y-3 text-sm text-[#6B7280]">
              <li>
                <a href="#product" className="hover:text-[#6366F1] transition-colors">
                  Tính năng
                </a>
              </li>
              <li>
                <a href="#pricing" className="hover:text-[#6366F1] transition-colors">
                  Bảng giá
                </a>
              </li>
              <li>
                <a href="#how-it-works" className="hover:text-[#6366F1] transition-colors">
                  Cách hoạt động
                </a>
              </li>
            </ul>
          </div>

          <div>
            <h4 className="font-semibold text-sm mb-4 tracking-tight">Công ty</h4>
            <ul className="space-y-3 text-sm text-[#6B7280]">
              <li>
                <a href="#about" className="hover:text-[#6366F1] transition-colors">
                  Về chúng tôi
                </a>
              </li>
              <li>
                <a href="#news" className="hover:text-[#6366F1] transition-colors">
                  Tin tức
                </a>
              </li>
              <li>
                <a href="#contact" className="hover:text-[#6366F1] transition-colors">
                  Liên hệ
                </a>
              </li>
            </ul>
          </div>

          <div>
            <h4 className="font-semibold text-sm mb-4 tracking-tight">Pháp lý</h4>
            <ul className="space-y-3 text-sm text-[#6B7280]">
              <li>
                <a href="#terms" className="hover:text-[#6366F1] transition-colors">
                  Điều khoản sử dụng
                </a>
              </li>
              <li>
                <a href="#privacy" className="hover:text-[#6366F1] transition-colors">
                  Chính sách bảo mật
                </a>
              </li>
            </ul>
          </div>

          <div>
            <h4 className="font-semibold text-sm mb-4 tracking-tight">Liên hệ</h4>
            <ul className="space-y-3 text-sm text-[#6B7280]">
              <li className="flex items-start gap-3">
                <FaPhone className="mt-0.5 flex-shrink-0" size={16} />
                <a href="tel:+84707970216" className="hover:text-[#6366F1] transition-colors">
                  +84 707 970 216
                </a>
              </li>
              <li className="flex items-start gap-3">
                <FaEnvelope className="mt-0.5 flex-shrink-0" size={16} />
                <a href="mailto:contact@alino.net" className="hover:text-[#6366F1] transition-colors">
                  contact@alino.net
                </a>
              </li>
              <li className="flex items-start gap-3 leading-relaxed">
                <FaMapMarkerAlt className="mt-0.5 flex-shrink-0" size={16} />
                <span>
                  Landmark 81
                  <br />
                  720A Điện Biên Phủ, Phường 22, Quận Bình Thạnh, TP. Hồ Chí Minh, Việt Nam
                </span>
              </li>
            </ul>
          </div>
        </div>

        <div className="pt-8 border-t border-black/5 text-center text-sm text-[#9CA3AF]">
          © 2025 ALINO. All rights reserved.
        </div>
      </div>
    </footer>
  )
}
</file>

<file path="src/components/ScrollToTop.tsx">
import { useEffect } from 'react'
import { useLocation } from 'react-router-dom'

/**
 * ScrollToTop component that scrolls to top on every route change.
 * This ensures that navigating between pages always starts at the top.
 */
export default function ScrollToTop() {
  const { pathname } = useLocation()

  useEffect(() => {
    window.scrollTo(0, 0)
  }, [pathname])

  return null
}
</file>

<file path="src/components/Toast.tsx">
import { useEffect } from 'react'

interface ToastProps {
  message: string
  type: 'success' | 'error'
  onClose: () => void
  duration?: number
}

export default function Toast({ message, type, onClose, duration = 3000 }: ToastProps) {
  useEffect(() => {
    const timer = setTimeout(() => {
      onClose()
    }, duration)

    return () => clearTimeout(timer)
  }, [duration, onClose])

  return (
    <div className="fixed top-4 right-4 z-50" style={{ animation: 'slideIn 0.3s ease-out' }}>
      <div
        className={`px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] ${
          type === 'success'
            ? 'bg-green-50 border border-green-200 text-green-800'
            : 'bg-red-50 border border-red-200 text-red-800'
        }`}
      >
        {type === 'success' ? (
          <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        ) : (
          <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        )}
        <span className="text-sm font-medium">{message}</span>
      </div>
    </div>
  )
}
</file>

<file path="src/lib/supabase.ts">
import { createClient } from '@supabase/supabase-js'
import type { SupabaseClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables')
}

let supabaseClient: SupabaseClient | null = null

export function getSupabase() {
  if (!supabaseClient) {
    supabaseClient = createClient(supabaseUrl, supabaseAnonKey, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
      },
    })
  }

  return supabaseClient
}
</file>

<file path="src/pages/BrandDashboard.tsx">
export default function BrandDashboard() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-[#EEF1FF] via-[#F5F7FF] to-white py-20 px-6 pt-24">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white/90 backdrop-blur-xl rounded-3xl p-12 shadow-xl border border-black/5 text-center">
          <h1 className="text-4xl font-semibold tracking-tight mb-4">
            Brand Dashboard
          </h1>
          <p className="text-lg text-[#6B7280]">
            Trang này đang được phát triển
          </p>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/pages/CreatorDashboard.tsx">
export default function CreatorDashboard() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-[#EEF1FF] via-[#F5F7FF] to-white py-20 px-6 pt-24">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white/90 backdrop-blur-xl rounded-3xl p-12 shadow-xl border border-black/5 text-center">
          <h1 className="text-4xl font-semibold tracking-tight mb-4">
            Creator Dashboard
          </h1>
          <p className="text-lg text-[#6B7280]">
            Trang này đang được phát triển
          </p>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/pages/SettingsPage.tsx">
import { useAuth } from '../hooks/useAuth'

export default function SettingsPage() {
  const { signOut } = useAuth()

  const handleChangePassword = async () => {
    // Coming soon
  }

  const handleChangeEmail = async () => {
    // Coming soon
  }

  const handleLogoutAll = async () => {
    // Coming soon
  }

  const handleDeleteAccount = async () => {
    // Coming soon
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#EEF1FF] via-[#F5F7FF] to-white py-20 px-6 pt-24">
      <div className="max-w-3xl mx-auto">
        <div className="bg-white/90 backdrop-blur-xl rounded-3xl p-8 md:p-10 shadow-xl border border-black/5">
          <h1 className="text-3xl font-semibold tracking-tight mb-8">Cài đặt</h1>

          <div className="space-y-6">

            <div className="border-b border-gray-200 pb-6">
              <h2 className="text-lg font-semibold text-[#374151] mb-2">Đổi mật khẩu</h2>
              <p className="text-sm text-[#6B7280] mb-4">
                Cập nhật mật khẩu của bạn để bảo vệ tài khoản
              </p>
              <button
                onClick={handleChangePassword}
                disabled
                className="px-6 py-2.5 rounded-xl font-medium text-[#6366F1] border border-[#6366F1] opacity-50 cursor-not-allowed"
              >
                Coming soon
              </button>
            </div>

            <div className="border-b border-gray-200 pb-6">
              <h2 className="text-lg font-semibold text-[#374151] mb-2">Đổi email</h2>
              <p className="text-sm text-[#6B7280] mb-4">
                Cập nhật địa chỉ email của bạn
              </p>
              <button
                onClick={handleChangeEmail}
                disabled
                className="px-6 py-2.5 rounded-xl font-medium text-[#6366F1] border border-[#6366F1] opacity-50 cursor-not-allowed"
              >
                Coming soon
              </button>
            </div>

            <div className="border-b border-gray-200 pb-6">
              <h2 className="text-lg font-semibold text-[#374151] mb-2">Đăng xuất tất cả thiết bị</h2>
              <p className="text-sm text-[#6B7280] mb-4">
                Đăng xuất khỏi tất cả các thiết bị và trình duyệt
              </p>
              <button
                onClick={handleLogoutAll}
                disabled
                className="px-6 py-2.5 rounded-xl font-medium text-[#6366F1] border border-[#6366F1] opacity-50 cursor-not-allowed"
              >
                Coming soon
              </button>
            </div>

            <div className="pb-6">
              <h2 className="text-lg font-semibold text-red-600 mb-2">Xóa tài khoản</h2>
              <p className="text-sm text-[#6B7280] mb-4">
                Xóa vĩnh viễn tài khoản và tất cả dữ liệu của bạn
              </p>
              <button
                onClick={handleDeleteAccount}
                disabled
                className="px-6 py-2.5 rounded-xl font-medium text-red-600 border border-red-600 opacity-50 cursor-not-allowed"
              >
                Coming soon
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/utils/cropImage.ts">
import { Area } from 'react-easy-crop'

export async function getCroppedImg(
  imageSrc: string,
  pixelCrop: Area
): Promise<Blob> {
  const image = await createImage(imageSrc)
  const canvas = document.createElement('canvas')
  const ctx = canvas.getContext('2d')

  if (!ctx) {
    throw new Error('No 2d context')
  }

  // Set canvas size to output size (circular crop)
  const outputSize = 400
  canvas.width = outputSize
  canvas.height = outputSize

  // Draw circular crop
  ctx.save()
  ctx.beginPath()
  ctx.arc(outputSize / 2, outputSize / 2, outputSize / 2, 0, Math.PI * 2)
  ctx.clip()

  // Draw cropped image
  ctx.drawImage(
    image,
    pixelCrop.x,
    pixelCrop.y,
    pixelCrop.width,
    pixelCrop.height,
    0,
    0,
    outputSize,
    outputSize
  )

  ctx.restore()

  return new Promise((resolve, reject) => {
    canvas.toBlob(
      (blob) => {
        if (!blob) {
          reject(new Error('Canvas is empty'))
          return
        }
        resolve(blob)
      },
      'image/jpeg',
      0.9
    )
  })
}

function createImage(url: string): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => {
    const image = new Image()
    image.addEventListener('load', () => resolve(image))
    image.addEventListener('error', (error) => reject(error))
    image.src = url
  })
}
</file>

<file path="supabase/migrations/001_create_profiles.sql">
-- Create profiles table
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  role TEXT CHECK (role IN ('creator', 'brand')),
  onboarding_completed BOOLEAN DEFAULT FALSE,
  onboarding_data JSONB DEFAULT '{}'::jsonb,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- RLS Policy: Users can read their own profile
CREATE POLICY "Users can read their own profile"
  ON public.profiles
  FOR SELECT
  USING (auth.uid() = id);

-- RLS Policy: Users can update their own profile
CREATE POLICY "Users can update their own profile"
  ON public.profiles
  FOR UPDATE
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id);

-- RLS Policy: Users can insert their own profile
CREATE POLICY "Users can insert their own profile"
  ON public.profiles
  FOR INSERT
  WITH CHECK (auth.uid() = id);

-- RLS Policy: Admin users (email ends with @alino.net) can read all profiles
CREATE POLICY "Admin users can read all profiles"
  ON public.profiles
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM auth.users
      WHERE auth.users.id = auth.uid()
      AND auth.users.email LIKE '%@alino.net'
    )
  );

-- RLS Policy: Admin users can update all profiles
CREATE POLICY "Admin users can update all profiles"
  ON public.profiles
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM auth.users
      WHERE auth.users.id = auth.uid()
      AND auth.users.email LIKE '%@alino.net'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM auth.users
      WHERE auth.users.id = auth.uid()
      AND auth.users.email LIKE '%@alino.net'
    )
  );

-- Function to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to update updated_at on profile updates
CREATE TRIGGER set_updated_at
  BEFORE UPDATE ON public.profiles
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_updated_at();

-- Create index on role for faster queries
CREATE INDEX IF NOT EXISTS idx_profiles_role ON public.profiles(role);

-- Create index on onboarding_completed for faster queries
CREATE INDEX IF NOT EXISTS idx_profiles_onboarding_completed ON public.profiles(onboarding_completed);
</file>

<file path="MIGRATION_GUIDE.md">
# Migration Guide: Next.js to Vite + React

## Overview
This project has been migrated from Next.js App Router to Vite + React for simplicity and predictability.

## Key Changes

### 1. Project Structure
- **Old**: `app/` directory with Next.js App Router
- **New**: `src/` directory with standard React structure

### 2. Routing
- **Old**: Next.js file-based routing (`app/page.tsx`, `app/login/page.tsx`)
- **New**: React Router with `src/router.tsx`

### 3. Authentication
- **Old**: Server-side auth with cookies, API routes
- **New**: Client-side only with Supabase client, localStorage persistence

### 4. No More Server Components
- All components are now client-side React components
- No SSR, no hydration issues

## Setup Instructions

1. **Install dependencies:**
```bash
npm install
```

2. **Create `.env` file:**
```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

3. **Start development server:**
```bash
npm run dev
```

## File Mapping

| Next.js | Vite + React |
|---------|--------------|
| `app/page.tsx` | `src/pages/LandingPage.tsx` |
| `app/login/page.tsx` | `src/pages/LoginPage.tsx` |
| `app/signup/page.tsx` | `src/pages/SignupPage.tsx` |
| `app/creator/page.tsx` | `src/pages/CreatorDashboard.tsx` |
| `app/brand/page.tsx` | `src/pages/BrandDashboard.tsx` |
| `app/profile/page.tsx` | `src/pages/ProfilePage.tsx` |
| `app/settings/page.tsx` | `src/pages/SettingsPage.tsx` |
| `app/components/layout/Header.tsx` | `src/components/layout/Header.tsx` |
| `lib/hooks/useAuth.ts` | `src/hooks/useAuth.ts` |
| `lib/supabase-client.ts` | `src/lib/supabase.ts` |

## Removed Concepts

- ❌ Server Components
- ❌ Route Handlers (`app/api/`)
- ❌ Server-side auth guards
- ❌ AuthGate component
- ❌ Middleware
- ❌ `layout.tsx`
- ❌ `next/image` (use `<img>`)
- ❌ `next/link` (use React Router `Link`)

## What Works Now

✅ Simple client-side routing
✅ Supabase auth with localStorage
✅ No navigation blocking
✅ Predictable behavior
✅ Easy to understand and modify

## Next Steps

1. Copy `vite-package.json` to `package.json`
2. Copy `vite.config.ts` to root
3. Copy `vite-tailwind.config.js` to `tailwind.config.js`
4. Copy `vite-postcss.config.js` to `postcss.config.js`
5. Copy `vite-tsconfig.json` to `tsconfig.json`
6. Copy `vite-tsconfig.node.json` to `tsconfig.node.json`
7. Move `src/` directory to root
8. Move `index.html` to root
9. Update environment variables to use `VITE_` prefix
10. Run `npm install` and `npm run dev`
</file>

<file path="postcss.config.cjs">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="PROFILES_IMPLEMENTATION.md">
# Profiles Implementation Guide

## Overview
This implementation creates `public.profiles` as the single source of truth for user data, with proper RLS policies for admin vs user access control.

## SQL Migration

Run the SQL migration file to create the profiles table and RLS policies:

**File:** `supabase/migrations/001_create_profiles.sql`

Execute this SQL in your Supabase SQL Editor or via Supabase CLI.

## Key Features

1. **Profiles Table**: Stores all user data including role, onboarding completion status, and all onboarding survey data
2. **RLS Policies**:
   - Users can read/update their own profile
   - Admin users (email ends with `@alino.net`) can read/update all profiles
3. **Data Flow**:
   - Role selection → Creates/updates profile in `profiles` table
   - Onboarding completion → Updates profile with survey data
   - Dashboards → Read from `profiles` table (via `/api/profile`)

## API Endpoints

### POST `/api/auth/role`
- Creates/updates profile with role
- Sets `onboarding_completed = false`

### POST `/api/auth/onboarding`
- Updates profile with onboarding survey data
- Sets `onboarding_completed = true`

### GET `/api/profile`
- Users: Returns their own profile
- Admins: Returns all profiles

## Admin Detection

Admin users are identified by email ending with `@alino.net` (checked in `lib/supabase-helpers.ts`).

## Notes

- `user_metadata` is still updated for AuthGate compatibility (role, onboardingCompleted flags)
- `profiles` table is the source of truth for all user data
- RLS policies enforce data access restrictions automatically
</file>

<file path="README_VITE.md">
# Vite + React Migration Complete

## Quick Start

1. **Install dependencies:**
```bash
npm install
```

2. **Set up environment variables:**
Create `.env` file:
```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

3. **Start development:**
```bash
npm run dev
```

## Project Structure

```
src/
  ├── main.tsx              # Entry point
  ├── App.tsx               # Root component with Router
  ├── router.tsx            # React Router configuration
  ├── index.css             # Global styles (Tailwind)
  ├── components/
  │   └── layout/
  │       ├── Header.tsx    # Navigation header
  │       ├── UserMenu.tsx  # User dropdown menu
  │       └── Footer.tsx    # Footer component
  ├── pages/
  │   ├── LandingPage.tsx
  │   ├── LoginPage.tsx
  │   ├── SignupPage.tsx
  │   ├── VerifyEmailPage.tsx
  │   ├── RolePage.tsx
  │   ├── OnboardingPage.tsx
  │   ├── CreatorDashboard.tsx
  │   ├── BrandDashboard.tsx
  │   ├── ProfilePage.tsx
  │   └── SettingsPage.tsx
  ├── hooks/
  │   └── useAuth.ts        # Auth hook (client-side only)
  └── lib/
      └── supabase.ts       # Supabase client setup
```

## Key Features

✅ **Simple Client-Side Auth**
- Supabase client with localStorage persistence
- No server-side auth checks
- Session persists across page refreshes

✅ **React Router**
- Clean, predictable routing
- Protected routes with simple guards
- No navigation blocking

✅ **No SSR Complexity**
- All components are client-side
- No hydration issues
- Easy to understand and modify

## Migration Notes

- All Next.js concepts removed (App Router, Server Components, Route Handlers)
- Auth is now 100% client-side
- Navigation always works - no redirect loops
- Profile/role checks happen in router, not on every navigation

## Next Steps

1. Copy all `vite-*` files to root (remove `vite-` prefix)
2. Move `src/` directory to root
3. Move `index.html` to root
4. Update environment variables
5. Run `npm install` and `npm run dev`
</file>

<file path="TECHNICAL_SUMMARY.md">
# ALINO APP - TECHNICAL SUMMARY

> **Tài liệu handover & review**  
> **Ngày cập nhật:** 26/12/2025  
> **Version:** Phase 1-3 Complete

---

## 1. PROJECT OVERVIEW

### Mục tiêu
Nền tảng kết nối **Creators** và **Brands** để tạo tăng trưởng thông qua Creator Marketing.

- **Creator**: Tạo profile chuyên nghiệp, quản lý booking, hợp đồng, nhận thanh toán
- **Brand**: Tìm creator phù hợp, quản lý campaign, tracking, báo cáo

### Tech Stack
- **Frontend**: React 18.2 + TypeScript
- **Build Tool**: Vite 5.0
- **Styling**: TailwindCSS 3.4
- **Routing**: React Router DOM v7.11
- **Backend**: Supabase (Auth + Database + Storage)
- **State**: React Query (profile data) + React Context (auth)
- **Deployment**: Vercel

### Bundle Size
- **Total**: 645KB (gzip: 184KB)
- **Acceptable** cho SaaS app với nhiều tính năng

---

## 2. KIẾN TRÚC HIỆN TẠI

### Folder Structure
```
src/
├── app/providers/         # Context providers (Auth)
├── components/            # Shared UI (Layout, Skeleton, Toast, ErrorBoundary)
├── features/              # Feature modules (auth, dashboard, landing, onboarding)
├── lib/                   # Utils (supabase, queries, errors, env)
├── pages/                 # Route entry points
└── shared/                # Types, routes, constants, enums
```

### Data Flow
```
Component → React Query (useProfile) → Supabase Client → PostgreSQL
                ↓ (cache 5min)
            Query Cache → Auto sync khi update
```

### Auth Flow
```
Login/Signup → Supabase Auth → Session → AuthProvider → RequireAuth → Pages
                                              ↓
                                        AppGate (check role + onboarding)
                                              ↓
                                    Dashboard (Creator/Brand)
```

### Core Components
- **ErrorBoundary**: Bắt lỗi toàn app, hiển thị fallback UI
- **AuthProvider**: Quản lý session/user, subscribe auth changes
- **RequireAuth**: Guard cho protected routes, check email verification
- **AppGate**: Logic routing theo role + onboarding status
- **Onboarding**: Chia thành CreatorOnboarding + BrandOnboarding
- **Profile**: Dynamic render theo role (Creator/Brand)

---

## 3. QUYẾT ĐỊNH KỸ THUẬT QUAN TRỌNG

### ✅ Phase 1: Critical Fixes

#### 1.1. Refactor Onboarding (657 lines → 3 files)
**Lý do**: Component quá lớn, khó maintain  
**Giải pháp**:
- `Onboarding.tsx`: Router (fetch + route theo role)
- `CreatorOnboarding.tsx`: Form riêng cho creator
- `BrandOnboarding.tsx`: Form riêng cho brand

**Trade-off**: Có duplicate code (avatar, validation) nhưng dễ extend độc lập.

#### 1.2. ErrorBoundary
**Lý do**: App crash → white screen, UX tệ  
**Giải pháp**: Class component bọc toàn app, catch errors, show fallback UI

#### 1.3. Fix Race Conditions
**Vấn đề**: Navigate trước khi data ready → query null  
**Giải pháp**:
- AuthProvider: Check `mounted` trong callbacks
- AuthCallback/AppGate: Thêm delay 100ms sau upsert trước khi navigate
- **Trade-off**: Delay nhỏ (100ms) nhưng đảm bảo data consistency

---

### ✅ Phase 2: React Query

#### 2.1. Tại sao dùng React Query?
**Vấn đề**:
- Profile fetch nhiều lần (AppGate, Profile, Settings)
- Không có cache → lãng phí bandwidth
- Update profile → phải refetch thủ công

**Giải pháp**:
- `useProfile()`: Fetch + cache 5 phút
- `useUpdateProfile()`: Mutation + auto invalidate cache
- **Scope**: CHỈ profile data (không migrate toàn bộ)

**Lợi ích**:
- Giảm API calls ~70%
- Data sync tự động across components
- Loading/error states nhất quán

#### 2.2. Tại sao không dùng Redux/Zustand?
- **Profile data**: Server state → React Query phù hợp
- **Auth state**: Simple context đủ (session + user)
- **Không có complex client state** cần global store

---

### ✅ Phase 3: Code Quality

#### 3.1. Enums thay Magic Strings
**Trước**:
```tsx
const checks = [['fullName', !fullName.trim()], ...];
if (profile.role === 'creator') { ... }
```

**Sau**:
```tsx
const checks = [[ProfileField.FULL_NAME, !fullName.trim()], ...];
if (profile.role === Role.CREATOR) { ... }
```

**Lợi ích**: Type safety, autocomplete, không typo

#### 3.2. Structured Error Handling
**Trước**: `catch (err) { setError('Lỗi...') }`  
**Sau**: `catch (err) { setError(handleError(new AppError(...))) }`

**Lợi ích**:
- Error codes cho debugging
- User-friendly messages (Tiếng Việt)
- Severity levels (info/warning/error/critical)
- Dễ tích hợp Sentry sau này

#### 3.3. Loading Skeletons
**Trước**: Spinner hoặc text "Đang tải..."  
**Sau**: Skeleton UI (giống content layout)

**Lợi ích**: Professional UX, perceived performance tốt hơn

---

## 4. NHỮNG THỨ CỐ TÌNH CHƯA LÀM

### ❌ React Hook Form + Zod
**Lý do**: 
- Form hiện tại đơn giản, validation thủ công đủ
- Thêm dependency ~50KB, chưa cần thiết
- **Khi nào cần**: Khi có form phức tạp (dynamic fields, nested validation)

### ❌ Form Validation Refactor
**Lý do**:
- Logic validation đang work, không có bug
- Refactor = high risk, low reward
- **Khi nào cần**: Khi scale form (thêm 10+ fields mới)

### ❌ Dashboard Implementation
**Lý do**: 
- Chỉ placeholder, chờ business confirm features
- Không rõ data model, workflow cụ thể
- **Đúng quyết định**: Không build blind

### ❌ Unit Tests
**Lý do**:
- MVP phase, focus stability trước
- Manual test đủ cho core flows
- **Khi nào cần**: Sau khi có 2-3 features nữa, setup CI/CD

### ❌ i18n (Internationalization)
**Lý do**:
- Target thị trường Việt Nam
- Thêm i18n = overhead, chậm development
- **Khi nào cần**: Khi expand sang thị trường nước ngoài

### ❌ Analytics/Monitoring
**Lý do**: Chưa có traffic, chưa cần optimize
- **Khi nào cần**: Sau khi launch public (100+ users)

---

## 5. HƯỚNG MỞ RỘNG TIẾP THEO

### 🎯 Business Priority

#### Ngắn hạn (1-2 tháng)
1. **Dashboard thực tế**
   - Creator: Deal management, content calendar, payment tracking
   - Brand: Campaign creation, creator discovery, analytics

2. **Booking Flow**
   - Brand gửi booking request
   - Creator accept/reject
   - Contract generation

3. **Payment Integration**
   - Escrow system
   - Invoice management
   - Payment history

#### Trung hạn (3-6 tháng)
4. **Messaging System** (Creator ↔ Brand communication)
5. **Content Review Flow** (upload → feedback → approve)
6. **Analytics Dashboard** (campaign performance, ROI)

#### Dài hạn (6-12 tháng)
7. **Marketplace** (public creator profiles, search/filter)
8. **AI Matching** (recommend creator based on brand needs)
9. **Mobile App** (React Native hoặc PWA)

---

### 🛠️ Tech Improvements

#### High Priority
1. **Unit Tests cho Critical Flows**
   - Auth (login, signup, password reset)
   - Onboarding (validation, data save)
   - Profile (update, avatar upload)
   - **Tool**: Vitest + React Testing Library

2. **Bundle Optimization**
   - Code splitting (React.lazy + Suspense)
   - Dynamic imports cho landing sections
   - Target: 645KB → 400KB
   - **Tool**: Vite rollupOptions

3. **Error Monitoring**
   - Integrate Sentry
   - Track errors với context (user, page, action)
   - Alert cho critical errors

#### Medium Priority
4. **Performance Monitoring**
   - Web Vitals (LCP, FID, CLS)
   - Custom metrics (API latency, query cache hit rate)
   - **Tool**: Vercel Analytics hoặc Google Analytics

5. **CI/CD Pipeline**
   - GitHub Actions
   - Auto test → build → deploy on PR
   - Branch previews

6. **Database Optimization**
   - Add indexes cho queries thường dùng
   - Setup RLS (Row Level Security) policies
   - Backup strategy

#### Nice to Have
7. **Design System** (Storybook for components)
8. **Accessibility Audit** (a11y compliance)
9. **PWA Support** (offline capability, push notifications)

---

## 📊 CURRENT STATUS

### ✅ Đã hoàn thành
- Auth flow (email/password + Google OAuth)
- Email verification
- Onboarding (Creator + Brand)
- Profile management
- Settings (account, security, password)
- Error handling
- Loading states
- Responsive design

### 🚧 Đang phát triển
- Dashboard (placeholder sẵn sàng)
- Business features (chờ spec)

### 📋 Technical Debt
- **Minimal** - Code quality cao, technical decisions đúng
- Chỉ có duplicate code nhỏ ở validation logic
- Không có major refactor cần thiết

---

## 🎓 LEARNING & BEST PRACTICES

### Quyết định đúng
✅ Dùng Vite (fast build)  
✅ Supabase (không cần backend riêng)  
✅ React Query (chỉ cho server state)  
✅ TypeScript strict mode (catch bugs sớm)  
✅ Feature-based folder structure (dễ scale)  
✅ ErrorBoundary (stability)  

### Trade-offs Hợp lý
⚖️ Delay 100ms (race condition fix) vs UX impact → OK  
⚖️ Manual validation vs library → OK cho form đơn giản  
⚖️ Client-side routing vs SSR → OK cho SaaS app  

### Patterns Nên Giữ
🔁 Gate pattern (AppGate cho routing logic)  
🔁 Provider pattern (AuthProvider)  
🔁 Feature modules (landing, auth, dashboard)  
🔁 Shared UI components (components/ui)  

---

## 📞 CONTACT & HANDOVER

### Codebase Ready
- ✅ Build thành công
- ✅ TypeScript no errors
- ✅ Git history sạch (3 commits cho 3 phases)
- ✅ Comments rõ ràng trong code

### Knowledge Transfer
- Đọc file này trước
- Review 3 commits: Phase 1, 2, 3
- Chạy local: `npm install` → `npm run dev`
- Check `.env.example` cho env vars

### Next Developer Should Know
1. **Auth flow** phức tạp (email verify, OAuth, role selection)
2. **Profile data** dùng React Query → check cache khi debug
3. **Validation logic** ở onboarding/profile → extend carefully
4. **AppGate** là single source of truth cho routing logic

---

**END OF DOCUMENT**
</file>

<file path="src/components/AuthGate.tsx">
import { useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuth } from '../hooks/useAuth'
import { useProfile } from '../hooks/useProfile'

export default function AuthGate({ children }: { children: React.ReactNode }) {
  const { session, loading: authLoading, isAuthenticated } = useAuth()
  const { profile, loading: profileLoading } = useProfile(
    session?.user?.id,
    isAuthenticated
  )
  const navigate = useNavigate()

  useEffect(() => {
    if (authLoading || profileLoading) return

    if (!session) {
      navigate('/login', { replace: true })
      return
    }

    if (!profile) return

    if (!profile.role) {
      navigate('/role', { replace: true })
      return
    }

    if (!profile.onboarding_completed) {
      navigate('/onboarding', { replace: true })
      return
    }
  }, [session, profile, authLoading, profileLoading, navigate])

  if (authLoading || profileLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        Đang tải...
      </div>
    )
  }

  return <>{children}</>
}
</file>

<file path="src/components/AvatarUpload.tsx">
import { useState, useRef } from 'react'
import Cropper, { Area } from 'react-easy-crop'
import { getSupabase } from '../lib/supabase'
import { getCroppedImg } from '../utils/cropImage'

interface AvatarUploadProps {
  currentAvatarUrl?: string
  onAvatarChange: (url: string) => void
  userId: string
}

const CROP_SIZE = 300 // Fixed crop circle size

export default function AvatarUpload({
  currentAvatarUrl,
  onAvatarChange,
  userId,
}: AvatarUploadProps) {
  const [imageSrc, setImageSrc] = useState<string | null>(null)
  const [showCropModal, setShowCropModal] = useState(false)
  const [crop, setCrop] = useState({ x: 0, y: 0 })
  const [zoom, setZoom] = useState(1)
  const [croppedAreaPixels, setCroppedAreaPixels] = useState<Area | null>(null)
  const [uploading, setUploading] = useState(false)

  const fileInputRef = useRef<HTMLInputElement>(null)

  /* ================= FILE SELECT ================= */

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
      alert('Chỉ hỗ trợ JPG, PNG, WEBP')
      return
    }

    if (file.size > 5 * 1024 * 1024) {
      alert('Ảnh tối đa 5MB')
      return
    }

    const reader = new FileReader()
    reader.onload = () => {
      setImageSrc(reader.result as string)
      setShowCropModal(true)
      setCrop({ x: 0, y: 0 })
      setZoom(1)
    }
    reader.readAsDataURL(file)
  }

  /* ================= CROP + UPLOAD ================= */

  const onCropComplete = (croppedArea: Area, croppedAreaPixels: Area) => {
    setCroppedAreaPixels(croppedAreaPixels)
  }

  const handleCrop = async () => {
    if (!imageSrc || !croppedAreaPixels) return

    setUploading(true)

    try {
      // Get cropped image blob
      const croppedImage = await getCroppedImg(imageSrc, croppedAreaPixels)
      
      if (!croppedImage) {
        throw new Error('Không thể crop ảnh')
      }

      // Upload to Supabase Storage
      const supabase = getSupabase()
      const timestamp = Date.now()
      const fileExt = 'jpg'
      const path = `${userId}/${timestamp}.${fileExt}`

      // Upload file to storage
      const { error: uploadError } = await supabase.storage
        .from('avatars')
        .upload(path, croppedImage, {
          upsert: true,
          contentType: 'image/jpeg',
        })

      if (uploadError) {
        throw new Error(`Upload failed: ${uploadError.message}`)
      }

      // Get public URL
      const { data: urlData } = supabase.storage
        .from('avatars')
        .getPublicUrl(path)

      if (!urlData?.publicUrl) {
        throw new Error('Failed to get public URL')
      }

      // Pass public URL to parent component
      onAvatarChange(urlData.publicUrl)

      // Close modal and reset
      setShowCropModal(false)
      setImageSrc(null)
      setCrop({ x: 0, y: 0 })
      setZoom(1)
      setCroppedAreaPixels(null)
    } catch (error: any) {
      console.error('Avatar upload error:', error)
      alert(error.message || 'Upload thất bại')
      // Reset state on error
      setShowCropModal(false)
      setImageSrc(null)
      setCrop({ x: 0, y: 0 })
      setZoom(1)
      setCroppedAreaPixels(null)
    } finally {
      setUploading(false)
    }
  }

  const handleCancel = () => {
    setShowCropModal(false)
    setImageSrc(null)
    setCrop({ x: 0, y: 0 })
    setZoom(1)
    setCroppedAreaPixels(null)
  }

  /* ================= RENDER ================= */

  return (
    <>
      {/* AVATAR */}
      <div className="flex flex-col items-center gap-2">
        <div
          onClick={() => fileInputRef.current?.click()}
          className="relative w-24 h-24 rounded-full overflow-hidden bg-gray-200 cursor-pointer group"
        >
          {currentAvatarUrl ? (
            <img src={currentAvatarUrl} alt="Avatar" className="w-full h-full object-cover" />
          ) : (
            <div className="w-full h-full flex items-center justify-center text-gray-400 text-4xl">
              👤
            </div>
          )}

          <div className="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 flex items-center justify-center transition">
            <span className="text-white text-xs font-medium">Đổi avatar</span>
          </div>
        </div>
      </div>

      <input
        ref={fileInputRef}
        type="file"
        accept="image/*"
        hidden
        onChange={handleFileSelect}
      />

      {/* MODAL */}
      {showCropModal && imageSrc && (
        <div className="fixed inset-0 z-50 bg-black/60 flex justify-center p-4">
          <div 
            className="bg-white rounded-xl p-5 w-full"
            style={{ 
              maxWidth: '400px',
              maxHeight: '80vh',
              display: 'flex',
              flexDirection: 'column',
            }}
          >
            <h3 className="font-semibold mb-4 flex-shrink-0">Chỉnh sửa avatar</h3>

            {/* Crop Area - Compact, centered */}
            <div
              className="relative mx-auto flex-shrink-0"
              style={{
                width: `${CROP_SIZE}px`,
                height: `${CROP_SIZE}px`,
                backgroundColor: '#000',
              }}
            >
              <Cropper
                image={imageSrc}
                crop={crop}
                zoom={zoom}
                aspect={1}
                cropShape="round"
                showGrid={true}
                onCropChange={setCrop}
                onZoomChange={setZoom}
                onCropComplete={onCropComplete}
                style={{
                  containerStyle: {
                    width: '100%',
                    height: '100%',
                  },
                }}
              />
            </div>

            {/* Zoom Control - Directly below crop */}
            <div className="mt-4 mb-4 flex-shrink-0" style={{ width: `${CROP_SIZE}px`, marginLeft: 'auto', marginRight: 'auto' }}>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Zoom
              </label>
              <input
                type="range"
                min="1"
                max="3"
                step="0.1"
                value={zoom}
                onChange={(e) => setZoom(parseFloat(e.target.value))}
                className="w-full"
              />
            </div>

            {/* Buttons - Always visible */}
            <div className="flex justify-end gap-2 mt-3 flex-shrink-0">
            <button
                onClick={handleCancel}
                disabled={uploading}
                className="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium disabled:opacity-50"
              >
                Hủy
              </button>
              <button
                onClick={handleCrop}
                disabled={uploading}
                className="px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-medium disabled:opacity-50"
              >
                {uploading ? 'Đang lưu…' : 'Lưu'}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  )
}
</file>

<file path="src/hooks/useAuth.ts">
import { useEffect, useState } from 'react'
import { useNavigate } from 'react-router-dom'
import type { Session } from '@supabase/supabase-js'
import { getSupabase } from '../lib/supabase'

export function useAuth() {
  const [session, setSession] = useState<Session | null>(null)
  const [loading, setLoading] = useState(true)
  const navigate = useNavigate()
  const supabase = getSupabase()

  useEffect(() => {
    let mounted = true

    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (!mounted) return
      setSession(session)
      setLoading(false)
    })

    // Listen for auth changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((event, session) => {
      if (!mounted) return
      setSession(session)
      setLoading(false)
    })

    return () => {
      mounted = false
      subscription.unsubscribe()
    }
  }, [])

  const signOut = async () => {
    await supabase.auth.signOut()
    setSession(null)
    navigate('/')
  }

  return {
    session,
    user: session?.user ?? null,
    loading,
    signOut,
    isAuthenticated: !!session,
  }
}
</file>

<file path="src/pages/AppGate.tsx">
import { useEffect, useState, useRef } from 'react'
import { useNavigate, useSearchParams } from 'react-router-dom'
import { useAuth } from '../hooks/useAuth'
import { getSupabase } from '../lib/supabase'

const GATE_TIMEOUT = 3000 // 3 seconds

export default function AppGate() {
  const { session, loading: authLoading } = useAuth()
  const navigate = useNavigate()
  const [searchParams] = useSearchParams()
  const supabase = getSupabase()
  const [loading, setLoading] = useState(true)
  const timeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null)
  const hasRedirected = useRef(false)

  useEffect(() => {
    // a) If not authenticated → do nothing (let other routes handle it)
    if (authLoading) return
    if (!session) return

    // b) If already redirected → do nothing
    if (hasRedirected.current) return

    // c) Email NOT verified → sign out → redirect to /
    if (!session.user.email_confirmed_at) {
      hasRedirected.current = true
      supabase.auth.signOut().finally(() => {
        navigate('/', { replace: true })
      })
      return
    }

    // d) Fetch profile DIRECTLY from Supabase (no cached hook)
    runGate()
  }, [authLoading, session, navigate, supabase])

  async function runGate() {
    if (!session) return

    // b) If already redirected → do nothing
    if (hasRedirected.current) return

    setLoading(true)

    // Set timeout fallback
    timeoutRef.current = setTimeout(() => {
      if (hasRedirected.current) return
      console.error('AppGate timeout')
      hasRedirected.current = true
      navigate('/', { replace: true })
    }, GATE_TIMEOUT)

    try {
      // Fetch existing profile
      const { data: profile, error: fetchError } = await supabase
        .from('profiles')
        .select('id, role, onboarding_completed')
        .eq('id', session.user.id)
        .single()

      // b) If already redirected → do nothing
      if (hasRedirected.current) return

      if (fetchError && fetchError.code === 'PGRST116') {
        // Profile doesn't exist, create it
        const { error: insertError } = await supabase
          .from('profiles')
          .insert({
            id: session.user.id,
            role: null,
            onboarding_completed: false,
          })

        if (insertError) {
          throw insertError
        }

        // After creating, redirect to role selection
        if (!hasRedirected.current) {
          hasRedirected.current = true
          navigate('/role', { replace: true })
        }
        return
      }

      if (fetchError) throw fetchError

      // b) If already redirected → do nothing
      if (hasRedirected.current) return

      // Profile exists, handle redirect based on state
      if (profile) {
        handleProfileRedirect(profile)
      }
    } catch (error) {
      // b) If already redirected → do nothing
      if (hasRedirected.current) return
      console.error('AppGate error:', error)
      hasRedirected.current = true
      navigate('/', { replace: true })
    } finally {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current)
        timeoutRef.current = null
      }
      setLoading(false)
    }
  }

  function handleProfileRedirect(profile: { role: string | null; onboarding_completed: boolean }) {
    // b) If already redirected → do nothing
    if (hasRedirected.current) return

    // d) If no role → redirect to /role
    if (!profile.role) {
      hasRedirected.current = true
      navigate('/role', { replace: true })
      return
    }

    // e) If onboarding_completed = false → redirect to /onboarding
    if (!profile.onboarding_completed) {
      hasRedirected.current = true
      navigate('/onboarding', { replace: true })
      return
    }

    // f) Else → redirect to /dashboard (or next param)
    hasRedirected.current = true
    const next = searchParams.get('next')
    if (next === 'projects' || next === 'profile' || next === 'settings') {
      navigate(`/${next}`, { replace: true })
    } else {
      navigate('/dashboard', { replace: true })
    }
  }

  if (authLoading || loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-[#6B7280]">Đang tải...</div>
      </div>
    )
  }

  return null
}
</file>

<file path="src/pages/LoginPage.tsx">
import { useState } from 'react'
import { Link, useNavigate } from 'react-router-dom'
import { getSupabase } from '../lib/supabase'

export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)
  const navigate = useNavigate()
  const supabase = getSupabase()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')
    setLoading(true)

    try {
      const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (error) {
        // Map error messages to Vietnamese
        if (error.message === 'Email not confirmed') {
          setError('Tài khoản chưa được xác thực')
        } else {
          setError('Email hoặc mật khẩu không đúng')
        }
        setLoading(false)
        return
      }

      navigate('/app')
    } catch (err) {
      setError('Có lỗi xảy ra')
      setLoading(false)
    }
  }

  const handleGoogleLogin = async () => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${window.location.origin}/app`,
      },
    })

    if (error) {
      setError(error.message)
      return
    }

    if (data.url) {
      window.location.href = data.url
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-[#F9FAFB] px-6 lg:px-6 pt-16">
      <div className="w-full max-w-6xl bg-white rounded-3xl shadow-xl overflow-hidden flex">
        <div className="hidden lg:flex w-[45%] bg-gradient-to-br from-[#6366F1]/20 via-[#7C3AED]/15 to-[#EC4899]/20">
          <div className="flex flex-col px-12 pt-12 items-center">
            <img
              src="/logo/logo.png"
              alt="ALINO"
              className="w-40 h-40 mb-6"
            />
            <h1 className="text-3xl font-semibold text-[#1F2937] mb-3">
              Chào mừng tới với Alino
            </h1>
            <p className="text-[#6B7280] leading-relaxed">
              Nền tảng quản lý các dự án hợp tác chuyên nghiệp
            </p>
          </div>
        </div>

        <div className="w-full lg:w-[55%] px-10 py-8 flex items-center justify-center">
          <div className="w-full max-w-sm">
            <h2 className="text-2xl font-semibold mb-2">Đăng nhập</h2>
            <p className="text-sm text-[#6B7280] mb-6">
              Nhập thông tin để tiếp tục
            </p>

            {error && (
              <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                {error}
              </div>
            )}

            <form onSubmit={handleSubmit} className="space-y-4">
              <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-3 py-2.5 border rounded-lg"
                required
              />

              <input
                type="password"
                placeholder="Mật khẩu"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-3 py-2.5 border rounded-lg"
                required
              />

              <button
                type="submit"
                disabled={loading}
                className="w-full py-2.5 rounded-lg text-white font-medium bg-gradient-to-r from-[#6366F1] to-[#EC4899] disabled:opacity-50"
              >
                {loading ? 'Đang đăng nhập...' : 'Đăng nhập'}
              </button>
            </form>

            <div className="my-5 text-center text-xs text-[#9CA3AF]">HOẶC</div>

            <button
              onClick={handleGoogleLogin}
              className="w-full py-2.5 border rounded-lg text-sm hover:bg-gray-50 flex items-center justify-center gap-3"
            >
              <svg className="w-5 h-5" viewBox="0 0 24 24">
                <path
                  fill="#4285F4"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="#34A853"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="#FBBC05"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="#EA4335"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
              Đăng nhập với Google
            </button>

            <p className="mt-6 text-center text-sm text-[#6B7280]">
              Chưa có tài khoản?{' '}
              <Link to="/signup" className="text-[#6366F1] font-medium">
                Đăng ký
              </Link>
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/pages/SignupPage.tsx">
import { useState } from 'react'
import { Link, useNavigate } from 'react-router-dom'
import { getSupabase } from '../lib/supabase'

export default function SignupPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)
  const navigate = useNavigate()
  const supabase = getSupabase()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')

    if (password !== confirmPassword) {
      setError('Mật khẩu xác nhận không khớp')
      return
    }

    if (password.length < 6) {
      setError('Mật khẩu phải có ít nhất 6 ký tự')
      return
    }

    setLoading(true)

    try {
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: `${window.location.origin}/verify-email`,
        },
      })

      if (error) {
        setError(error.message || 'Đăng ký thất bại')
        setLoading(false)
        return
      }

      navigate('/?signup=success', { replace: true })
    } catch (err) {
      setError('Có lỗi xảy ra')
      setLoading(false)
    }
  }

  const handleGoogleSignup = async () => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: `${window.location.origin}/app`,
      },
    })

    if (error) {
      setError(error.message)
      return
    }

    if (data.url) {
      window.location.href = data.url
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-[#F9FAFB] px-6 pt-16">
      <div className="w-full max-w-6xl bg-white rounded-3xl shadow-xl overflow-hidden flex">
        <div className="hidden lg:flex w-[45%] bg-gradient-to-br from-[#6366F1]/20 via-[#7C3AED]/15 to-[#EC4899]/20">
          <div className="flex flex-col px-12 pt-12 items-center">
            <img
              src="/logo/logo.png"
              alt="ALINO"
              className="w-40 h-40 mb-6"
            />
            <h1 className="text-3xl font-semibold text-[#1F2937] mb-3">
              Tạo tài khoản mới
            </h1>
            <p className="text-[#6B7280] leading-relaxed">
              Bắt đầu hành trình hợp tác với Alino
            </p>
          </div>
        </div>

        <div className="w-full lg:w-[55%] px-10 py-8 flex items-center justify-center">
          <div className="w-full max-w-sm">
            <h2 className="text-2xl font-semibold mb-2">Đăng ký</h2>
            <p className="text-sm text-[#6B7280] mb-6">
              Tạo tài khoản mới để bắt đầu
            </p>

            {error && (
              <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                {error}
              </div>
            )}

            <form onSubmit={handleSubmit} className="space-y-4">
              <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full px-3 py-2.5 border rounded-lg"
                required
              />

              <input
                type="password"
                placeholder="Mật khẩu"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full px-3 py-2.5 border rounded-lg"
                required
              />

              <input
                type="password"
                placeholder="Xác nhận mật khẩu"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                className="w-full px-3 py-2.5 border rounded-lg"
                required
              />

              <button
                type="submit"
                disabled={loading}
                className="w-full py-2.5 rounded-lg text-white font-medium bg-gradient-to-r from-[#6366F1] to-[#EC4899] disabled:opacity-50"
              >
                {loading ? 'Đang tạo tài khoản...' : 'Đăng ký'}
              </button>
            </form>

            <div className="my-5 text-center text-xs text-[#9CA3AF]">HOẶC</div>

            <button
              onClick={handleGoogleSignup}
              className="w-full py-2.5 border rounded-lg text-sm hover:bg-gray-50 flex items-center justify-center gap-3"
            >
              <svg className="w-5 h-5" viewBox="0 0 24 24">
                <path
                  fill="#4285F4"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="#34A853"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="#FBBC05"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="#EA4335"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
              Đăng ký với Google
            </button>

            <p className="mt-6 text-center text-sm text-[#6B7280]">
              Đã có tài khoản?{' '}
              <Link to="/login" className="text-[#6366F1] font-medium">
                Đăng nhập
              </Link>
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/pages/VerifyEmailPage.tsx">
import { useEffect } from 'react'
import { Link } from 'react-router-dom'
import { getSupabase } from '../lib/supabase'

export default function VerifyEmailPage() {
  const supabase = getSupabase()

  useEffect(() => {
    // Sign out any existing session to prevent auto-login
    supabase.auth.signOut()
  }, [])

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#EEF1FF] via-[#F5F7FF] to-white py-20 px-6 pt-24">
      <div className="w-full max-w-md">
        <div className="bg-white/90 backdrop-blur-xl rounded-3xl p-8 shadow-xl border border-black/5 text-center">
          <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-r from-[#6366F1] to-[#EC4899] flex items-center justify-center">
            <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>

          <h1 className="text-3xl font-semibold tracking-tight mb-4">
            Xác thực thành công
          </h1>

          <p className="text-[#6B7280] mb-8 leading-relaxed">
            Tài khoản đã được xác thực. Vui lòng đăng nhập để tiếp tục.
          </p>

          <Link
            to="/login"
            className="inline-block px-6 py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-[#6366F1] to-[#EC4899] hover:scale-105 transition-transform shadow-lg shadow-[#6366F1]/25"
          >
            Đăng nhập
          </Link>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/components/layout/Header.tsx">
import { Link, useLocation, useNavigate } from 'react-router-dom'
import { useState } from 'react'
import { FaBell } from 'react-icons/fa'
import { useAuth } from '../../hooks/useAuth'
import { useProfile } from '../../hooks/useProfile'
import UserMenu from './UserMenu'
import NotificationModal from '../dashboard/NotificationModal'

export default function Header() {
  const { session, loading: authLoading, isAuthenticated } = useAuth()
  const { profile } = useProfile(session?.user?.id, isAuthenticated)
  const location = useLocation()
  const navigate = useNavigate()
  const [isNotificationModalOpen, setIsNotificationModalOpen] = useState(false)

  // Check if we're in dashboard mode
  const isDashboardMode = location.pathname.startsWith('/dashboard') || 
                          location.pathname.startsWith('/profile') ||
                          location.pathname.startsWith('/settings')

  const handleLogoClick = (e: React.MouseEvent) => {
    e.preventDefault()
    if (location.pathname !== '/') {
      navigate('/')
    }
    window.scrollTo({ top: 0, behavior: 'smooth' })
  }

  // Read display_name and avatar_url from profiles table FIRST (primary source)
  // Fallback to auth metadata if profile not loaded or avatar_url is null
  const displayName = profile?.display_name || session?.user?.user_metadata?.display_name || undefined
  const avatarUrl = profile?.avatar_url || session?.user?.user_metadata?.avatar_url || undefined

  // Mock unread count - replace with real data later
  const unreadNotificationCount = 4

  // Get dashboard title and subtitle based on current route
  const getDashboardTitle = () => {
    const path = location.pathname
    const firstName = displayName?.split(' ')[0] || 'Thành' // Default to "Thành" if no name
    
    if (path === '/dashboard') {
      return {
        title: `Xin chào ${firstName}`,
        subtitle: 'Chào mừng bạn đã quay trở lại 👋'
      }
    }
    if (path === '/dashboard/profile-public') {
      return {
        title: 'Hồ sơ công khai',
        subtitle: 'Quản lý thông tin hiển thị của bạn với đối tác'
      }
    }
    if (path === '/dashboard/services') {
      return {
        title: 'Dịch vụ & Bảng giá',
        subtitle: 'Thiết lập dịch vụ và mức giá bạn cung cấp'
      }
    }
    if (path === '/dashboard/opportunities') {
      return {
        title: 'Cơ hội hợp tác',
        subtitle: 'Khám phá các cơ hội phù hợp với bạn'
      }
    }
    if (path === '/dashboard/proposals') {
      return {
        title: 'Đề xuất',
        subtitle: 'Quản lý các đề xuất hợp tác đang diễn ra'
      }
    }
    if (path === '/dashboard/workspace') {
      return {
        title: 'Trung tâm làm việc',
        subtitle: 'Theo dõi và xử lý các hoạt động hợp tác'
      }
    }
    if (path === '/dashboard/analytics') {
      return {
        title: 'Phân tích',
        subtitle: 'Theo dõi hiệu suất và tăng trưởng của bạn'
      }
    }
    return null
  }

  const dashboardTitle = isDashboardMode ? getDashboardTitle() : null

  return (
    <>
      <header className={`fixed top-0 inset-x-0 z-50 bg-white/80 backdrop-blur-xl border-b border-black/5 ${isDashboardMode && dashboardTitle ? 'h-20' : 'h-16'}`}>
        <div className="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
          <div className="flex items-center gap-6">
            <Link
              to="/"
              onClick={handleLogoClick}
              className="flex items-center gap-3 cursor-pointer flex-shrink-0"
            >
              <img src="/logo/logo.png" alt="ALINO" className="w-8 h-8" />
              <span className="font-semibold text-lg tracking-tight bg-gradient-to-r from-[#6366F1] to-[#EC4899] bg-clip-text text-transparent">
                ALINO
              </span>
            </Link>

            {/* Dashboard Title & Subtitle - only show in dashboard mode */}
            {isDashboardMode && dashboardTitle && (
              <div className="hidden md:block border-l border-gray-200 pl-6">
                <h1 className="text-lg font-semibold text-gray-900 leading-tight">{dashboardTitle.title}</h1>
                <p className="text-sm text-gray-500 leading-tight mt-0.5">{dashboardTitle.subtitle}</p>
              </div>
            )}
          </div>

          {/* Landing page navigation - only show when NOT in dashboard mode */}
          {!isDashboardMode && (
            <nav className="hidden md:flex items-center gap-10 text-sm text-[#6B7280]">
              <a href="#about">Về chúng tôi</a>
              <a href="#product">Sản phẩm</a>
              <a href="#news">Tin tức</a>
              <a href="#contact">Liên hệ</a>
            </nav>
          )}

          <div className="flex items-center gap-4 text-sm">
            {authLoading ? null : session ? (
              <>
                {/* Notification Icon - only show in dashboard mode */}
                {isDashboardMode && (
                  <button
                    onClick={() => setIsNotificationModalOpen(true)}
                    className="relative p-2 text-gray-600 hover:text-[#6366F1] transition-colors"
                  >
                    <FaBell className="w-5 h-5" />
                    {unreadNotificationCount > 0 && (
                      <span className="absolute top-0 right-0 w-4 h-4 bg-gradient-to-r from-[#6366F1] to-[#EC4899] text-white text-xs font-bold rounded-full flex items-center justify-center">
                        {unreadNotificationCount}
                      </span>
                    )}
                  </button>
                )}
                <UserMenu 
                  userEmail={session.user.email || ''}
                  displayName={displayName}
                  avatarUrl={avatarUrl}
                />
              </>
            ) : (
              <>
                <Link to="/login">Đăng nhập</Link>
                <Link
                  to="/signup"
                  className="px-5 py-2.5 rounded-full text-white bg-gradient-to-r from-[#6366F1] to-[#EC4899]"
                >
                  Đăng ký
                </Link>
              </>
            )}
          </div>
        </div>
      </header>

      {/* Notification Modal */}
      <NotificationModal 
        isOpen={isNotificationModalOpen} 
        onClose={() => setIsNotificationModalOpen(false)} 
      />
    </>
  )
}
</file>

<file path="src/components/layout/UserMenu.tsx">
import { useState, useRef, useEffect } from 'react'
import { Link, useNavigate } from 'react-router-dom'
import { useAuth } from '../../hooks/useAuth'

interface UserMenuProps {
  userEmail: string
  displayName?: string
  avatarUrl?: string | null
  role?: string | null
}

export default function UserMenu({ userEmail, displayName, avatarUrl, role }: UserMenuProps) {
  const [isOpen, setIsOpen] = useState(false)
  const menuRef = useRef<HTMLDivElement>(null)
  const navigate = useNavigate()
  const { signOut } = useAuth()

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setIsOpen(false)
      }
    }

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside)
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside)
    }
  }, [isOpen])

  const handleLogout = async () => {
    setIsOpen(false)
    await signOut()
  }

  const dashboardPath = '/app?next=projects'

  const nameToShow = displayName || userEmail.split('@')[0]

  return (
    <div
      className="relative"
      ref={menuRef}
      onMouseEnter={() => setIsOpen(true)}
      onMouseLeave={() => setIsOpen(false)}
    >
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-0 py-0 text-[#6B7280] hover:text-[#6366F1] transition-colors group"
      >
        {avatarUrl ? (
          <img 
            src={avatarUrl} 
            alt={nameToShow}
            className="w-6 h-6 rounded-full object-cover flex-shrink-0"
          />
        ) : (
          <div className="w-6 h-6 rounded-full bg-gradient-to-r from-[#6366F1] to-[#EC4899] flex items-center justify-center text-white font-medium text-xs flex-shrink-0">
            {nameToShow.charAt(0).toUpperCase()}
          </div>
        )}
        <span className="text-sm whitespace-nowrap">
          {nameToShow}
        </span>
      </button>

      {isOpen && (
        <div className="absolute right-0 top-full pt-2 w-56 z-50">
          <div className="bg-white rounded-xl shadow-lg border border-gray-200 py-2">
            <Link
              to={dashboardPath}
              onClick={() => setIsOpen(false)}
              className="block px-4 py-2.5 text-sm text-[#374151] hover:bg-gray-50 transition-colors"
            >
              Quản lý dự án
            </Link>
            <Link
              to="/app?next=profile"
              onClick={() => setIsOpen(false)}
              className="block px-4 py-2.5 text-sm text-[#374151] hover:bg-gray-50 transition-colors"
            >
              Hồ sơ
            </Link>
            <Link
              to="/app?next=settings"
              onClick={() => setIsOpen(false)}
              className="block px-4 py-2.5 text-sm text-[#374151] hover:bg-gray-50 transition-colors"
            >
              Cài đặt
            </Link>
            <div className="border-t border-gray-200 my-1" />
            <button
              onClick={handleLogout}
              className="block w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-gray-50 transition-colors"
            >
              Đăng xuất
            </button>
          </div>
        </div>
      )}
    </div>
  )
}
</file>

<file path="src/pages/LandingPage.tsx">
import { useEffect, useState } from 'react'
import { Link, useSearchParams } from 'react-router-dom'

export default function LandingPage() {
  const [searchParams, setSearchParams] = useSearchParams()
  const [showMessage, setShowMessage] = useState(false)

  useEffect(() => {
    if (searchParams.get('signup') === 'success') {
      setShowMessage(true)
      // Remove query param from URL
      setSearchParams({}, { replace: true })
    }
  }, [searchParams, setSearchParams])

  return (
    <div className="relative overflow-x-hidden bg-white pt-16">
      <div className="min-h-screen">
        <section className="max-w-7xl mx-auto px-6 py-20">
          <div className="text-center">
            {showMessage && (
              <div className="mb-8 max-w-2xl mx-auto">
                <div className="bg-green-50 border border-green-200 rounded-xl p-4 text-green-700">
                  <p className="font-medium">
                    Vui lòng kiểm tra email để xác thực tài khoản.
                  </p>
                </div>
              </div>
            )}
            <h1 className="text-5xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-[#6366F1] to-[#EC4899] bg-clip-text text-transparent">
              Quản lý hợp tác Creator - Brand
            </h1>
            <p className="text-xl text-[#6B7280] mb-8 max-w-2xl mx-auto">
              Nền tảng quản lý hợp tác chuyên nghiệp giữa Creator và Brand
            </p>
            <div className="flex gap-4 justify-center">
              <Link
                to="/signup"
                className="px-8 py-3 rounded-full font-semibold text-white bg-gradient-to-r from-[#6366F1] to-[#EC4899] hover:scale-105 transition-transform shadow-lg shadow-[#6366F1]/25"
              >
                Bắt đầu ngay
              </Link>
              <Link
                to="/login"
                className="px-8 py-3 rounded-full font-semibold text-[#6366F1] border-2 border-[#6366F1] hover:bg-[#6366F1] hover:text-white transition-colors"
              >
                Đăng nhập
              </Link>
            </div>
          </div>
        </section>
      </div>
    </div>
  )
}
</file>

<file path="src/pages/RolePage.tsx">
import { useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuth } from '../hooks/useAuth'
import { getSupabase } from '../lib/supabase'

export default function RolePage() {
  const { session } = useAuth()
  const [loading, setLoading] = useState(false)
  const navigate = useNavigate()
  const supabase = getSupabase()

  const handleSelectRole = async (role: 'creator' | 'brand') => {
    if (!session) return

    setLoading(true)

    try {
      // Update role directly to profiles table
      const { error } = await supabase
        .from('profiles')
        .update({
          role,
          updated_at: new Date().toISOString(),
        })
        .eq('id', session.user.id)

      if (error) throw error

      // After success → navigate('/app')
      navigate('/app', { replace: true })
    } catch (err: any) {
      setLoading(false)
      alert(err.message || 'Có lỗi xảy ra khi chọn vai trò')
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#EEF1FF] via-[#F5F7FF] to-white py-20 px-6 pt-24">
      <div className="w-full max-w-4xl">
        <div className="text-center mb-12">
          <h1 className="text-4xl md:text-5xl font-semibold tracking-tight mb-4">
            Chọn vai trò của bạn
          </h1>
          <p className="text-lg text-[#6B7280] max-w-2xl mx-auto">
            Chọn vai trò phù hợp với cách bạn sử dụng ALINO. Bạn có thể thay đổi sau.
          </p>
        </div>

        <div className="grid md:grid-cols-2 gap-6">
          <button
            onClick={() => handleSelectRole('creator')}
            disabled={loading}
            className="p-8 bg-white rounded-2xl border-2 border-gray-200 hover:border-[#6366F1] transition-colors text-left disabled:opacity-50"
          >
            <h3 className="text-2xl font-semibold mb-2">Creator</h3>
            <p className="text-[#6B7280]">
              Tôi là Creator muốn hợp tác với các Brand
            </p>
          </button>

          <button
            onClick={() => handleSelectRole('brand')}
            disabled={loading}
            className="p-8 bg-white rounded-2xl border-2 border-gray-200 hover:border-[#6366F1] transition-colors text-left disabled:opacity-50"
          >
            <h3 className="text-2xl font-semibold mb-2">Brand</h3>
            <p className="text-[#6B7280]">
              Tôi là Brand muốn hợp tác với các Creator
            </p>
          </button>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/types/profile.ts">
// Core profile fields (matches FINAL schema)
export interface Profile {
  id: string
  role: 'creator' | 'brand' | null
  display_name?: string | null
  avatar_url?: string | null
  bio?: string | null
  birth_year?: number | null
  country?: string | null
  city?: string | null
  onboarding_completed: boolean
  onboarding_data?: any
  is_admin?: boolean
  created_at?: string
  updated_at?: string
}

// Creator-specific fields (matches FINAL schema)
export interface CreatorProfile extends Profile {
  role: 'creator'
  creator_platforms?: string[] | null // TEXT[]
  content_categories?: string[] | null // TEXT[]
  followers_count?: number | null
  avg_views?: number | null
  collaboration_expectation?: string[] | null // TEXT[]
}

// Brand-specific fields (matches FINAL schema)
export interface BrandProfile extends Profile {
  role: 'brand'
  brand_name?: string | null
  industry?: string | null
  company_size?: string | null
  monthly_marketing_budget?: number | null // NUMERIC
  target_platforms?: string[] | null // TEXT[]
  collaboration_goal?: string[] | null // TEXT[]
}

export type ProfileWithRole = CreatorProfile | BrandProfile
</file>

<file path="src/router.tsx">
import { Routes, Route, Navigate } from 'react-router-dom'
import { useEffect, useState } from 'react'
import { useAuth } from './hooks/useAuth'
import { useProfile } from './hooks/useProfile'
import LandingPage from './pages/LandingPage'
import LoginPage from './pages/LoginPage'
import SignupPage from './pages/SignupPage'
import VerifyEmailPage from './pages/VerifyEmailPage'
import AppGate from './pages/AppGate'
import RolePage from './pages/RolePage'
import OnboardingPage from './pages/OnboardingPage'
import CreatorDashboard from './pages/CreatorDashboard'
import BrandDashboard from './pages/BrandDashboard'
import Dashboard from './pages/Dashboard'
import DashboardHome from './pages/DashboardHome'
import ComingSoonPage from './pages/ComingSoonPage'
import ProfilePage from './pages/ProfilePage'
import SettingsPage from './pages/SettingsPage'

function ProtectedRoute({ children }: { children: React.ReactNode }) {
  const { session, loading } = useAuth()

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-[#6B7280]">Đang tải...</div>
      </div>
    )
  }

  if (!session) {
    return <Navigate to="/login" replace />
  }

  return <>{children}</>
}

function PublicRoute({ children }: { children: React.ReactNode }) {
  const { session, loading } = useAuth()

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-[#6B7280]">Đang tải...</div>
      </div>
    )
  }

  if (session) {
    return <Navigate to="/app" replace />
  }

  return <>{children}</>
}

export function Router() {
  return (
    <Routes>
      <Route path="/" element={<LandingPage />} />
      
      <Route
        path="/login"
        element={
          <PublicRoute>
            <LoginPage />
          </PublicRoute>
        }
      />
      
      <Route
        path="/signup"
        element={
          <PublicRoute>
            <SignupPage />
          </PublicRoute>
        }
      />
      
      <Route path="/verify-email" element={<VerifyEmailPage />} />

      <Route path="/app" element={<AppGate />} />

      <Route
        path="/role"
        element={
          <ProtectedRoute>
            <RolePage />
          </ProtectedRoute>
        }
      />

      <Route
        path="/onboarding"
        element={
          <ProtectedRoute>
            <OnboardingPage />
          </ProtectedRoute>
        }
      />

      <Route
        path="/dashboard"
        element={<DashboardEntry />}
      />

      <Route
        path="/dashboard/profile-public"
        element={<DashboardEntry />}
      />

      <Route
        path="/dashboard/services"
        element={<DashboardEntry />}
      />

      <Route
        path="/dashboard/opportunities"
        element={<DashboardEntry />}
      />

      <Route
        path="/dashboard/proposals"
        element={<DashboardEntry />}
      />

      <Route
        path="/dashboard/workspace"
        element={<DashboardEntry />}
      />

      <Route
        path="/dashboard/analytics"
        element={<DashboardEntry />}
      />

      <Route
        path="/projects"
        element={<DashboardEntry />}
      />

      <Route
        path="/profile"
        element={
          <ProtectedRoute>
            <ProfilePage />
          </ProtectedRoute>
        }
      />

      <Route
        path="/settings"
        element={
          <ProtectedRoute>
            <SettingsPage />
          </ProtectedRoute>
        }
      />

      <Route path="*" element={<Navigate to="/" replace />} />
    </Routes>
  )
}

function DashboardEntry() {
  const { session, loading: authLoading, user, isAuthenticated } = useAuth()
  const { profile, loading: profileLoading, error: profileError } = useProfile(user?.id, isAuthenticated)

  // a) If not authenticated → do nothing (let AppGate handle it)
  if (authLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-[#6B7280]">Đang tải...</div>
      </div>
    )
  }

  if (!session) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-[#6B7280]">Đang tải...</div>
      </div>
    )
  }

  // b) If profile is loading → do nothing (show loading)
  if (profileLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-[#6B7280]">Đang tải...</div>
      </div>
    )
  }

  // c) If profile error or missing → let AppGate handle redirect (don't redirect here)
  if (profileError || !profile) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-[#6B7280]">Đang tải...</div>
      </div>
    )
  }

  // Profile loaded successfully, render unified dashboard
  return <Dashboard />
}
</file>

<file path="src/vite-env.d.ts">
/// <reference types="vite/client" />
</file>

<file path="src/hooks/useProfile.ts">
import { useEffect, useState, useRef } from 'react'
import { getSupabase } from '../lib/supabase'
import type { Profile } from '../types/profile'

const PROFILE_FETCH_TIMEOUT = 3000 // 3 seconds

export function useProfile(
  userId: string | undefined,
  enabled: boolean
) {
  const [profile, setProfile] = useState<Profile | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const supabase = getSupabase()
  const timeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null)

  useEffect(() => {
    if (!enabled || !userId) {
      setProfile(null)
      setLoading(false)
      setError(null)
      return
    }
  
    let mounted = true
  
    async function fetchProfile() {
      setLoading(true)
      setError(null)
  
      timeoutRef.current = setTimeout(() => {
        if (mounted) {
          setLoading(false)
          setError('Timeout loading profile')
        }
      }, PROFILE_FETCH_TIMEOUT)
  
      try {
        const { data, error: fetchError } = await supabase
  .from('profiles')
  .select(`
    id,
    role,
    onboarding_completed,
    avatar_url,
    display_name,
    bio,
    birth_year,
    country,
    city,
    followers_count,
    avg_views,
    creator_platforms,
    content_categories,
    collaboration_expectation,
    brand_name,
    industry,
    company_size,
    monthly_marketing_budget,
    target_platforms,
    collaboration_goal,
    created_at,
    updated_at
  `)
  .eq('id', userId)
  .single()
  
        if (timeoutRef.current) {
          clearTimeout(timeoutRef.current)
          timeoutRef.current = null
        }
  
        if (fetchError) {
          if (mounted) {
            setError(fetchError.message)
            setLoading(false)
          }
          return
        }
  
        if (mounted && data) {
          setProfile(data)
          setLoading(false)
        }
      } catch (err: any) {
        if (mounted) {
          setError(err.message || 'Failed to load profile')
          setLoading(false)
        }
      }
    }
  
    fetchProfile()
  
    return () => {
      mounted = false
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current)
      }
    }
  }, [userId, enabled, supabase])
  

  return { profile, loading, error }
}
</file>

<file path="src/pages/OnboardingPage.tsx">
import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuth } from '../hooks/useAuth'
import { getSupabase } from '../lib/supabase'

// Form state interfaces
interface CreatorFormData {
  display_name?: string
  country?: string
  city?: string
  birth_year?: number
  creator_platforms?: string[]
  followers_count?: number
  avg_views?: number
  content_categories?: string[]
  collaboration_expectation?: ('paid' | 'gift' | 'affiliate')[]
}

interface BrandFormData {
  company_name?: string
  industry?: string
  country?: string
  city?: string
  company_size?: string
  budget?: number
  campaign_budget_range?: string
  target_platforms?: string[]
  campaign_goal?: string
  preferred_collaboration_type?: ('paid' | 'gift' | 'affiliate')[]
}

export default function OnboardingPage() {
  const { session } = useAuth()
  const navigate = useNavigate()
  const supabase = getSupabase()
  const [currentStep, setCurrentStep] = useState(1)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [role, setRole] = useState<'creator' | 'brand' | null>(null)
  
  // Form state - separate for creator and brand
  const [creatorData, setCreatorData] = useState<CreatorFormData>({})
  const [brandData, setBrandData] = useState<BrandFormData>({})

  useEffect(() => {
    if (!session) return
    checkOnboardingStatus()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [session])

  async function checkOnboardingStatus() {
    if (!session) return

    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('onboarding_completed, role, onboarding_data')
        .eq('id', session.user.id)
        .single()

      if (error && error.code !== 'PGRST116') throw error

      // Let AppGate handle redirects - don't redirect here
      if (data?.role) {
        setRole(data.role)
        loadExistingData(data.role, data.onboarding_data)
      }
    } catch (err) {
      console.error('Error checking onboarding:', err)
    }
  }

  async function loadExistingData(userRole: 'creator' | 'brand', onboardingData: any) {
    if (!session) return

    try {
      // Read from onboarding_data JSON, not profile columns
      const data = onboardingData || {}

      if (userRole === 'creator') {
        const step2 = data.step2 || {}
        const step3 = data.step3 || {}
        const step4 = data.step4 || {}
        
        const cd: CreatorFormData = {
          display_name: step2.display_name || undefined,
          country: step2.country || undefined,
          city: step2.city || undefined,
          birth_year: step2.birth_year || undefined,
          creator_platforms: step3.creator_platforms || undefined,
          followers_count: step3.followers_count || undefined,
          avg_views: step3.avg_views || undefined,
          content_categories: step3.content_categories || undefined,
          collaboration_expectation: step4.collaboration_expectation || undefined,
        }
        setCreatorData(cd)

        // Determine current step based on onboarding_data
        if (!step2.display_name) {
          setCurrentStep(2)
        } else if (!step3.creator_platforms || step3.creator_platforms.length === 0) {
          setCurrentStep(3)
        } else if (!step4.collaboration_expectation || step4.collaboration_expectation.length === 0) {
          setCurrentStep(4)
        } else {
          setCurrentStep(5)
        }
      } else {
        const step2 = data.step2 || {}
        const step3 = data.step3 || {}
        const step4 = data.step4 || {}
        
        const bd: BrandFormData = {
          company_name: step2.company_name || undefined,
          industry: step2.industry || undefined,
          country: step2.country || undefined,
          city: step2.city || undefined,
          company_size: step3.company_size || undefined,
          budget: step3.budget || undefined,
          campaign_budget_range: step3.campaign_budget_range || undefined,
          target_platforms: step3.target_platforms || undefined,
          campaign_goal: step4.campaign_goal || undefined,
          preferred_collaboration_type: step4.preferred_collaboration_type || undefined,
        }
        setBrandData(bd)

        // Determine current step based on onboarding_data
        if (!step2.company_name) {
          setCurrentStep(2)
        } else if (!step3.company_size) {
          setCurrentStep(3)
        } else if (!step4.campaign_goal) {
          setCurrentStep(4)
        } else {
          setCurrentStep(5)
        }
      }
    } catch (err) {
      console.error('Error loading existing data:', err)
    }
  }

  // Helper to merge onboarding_data JSON
  async function mergeOnboardingData(stepKey: string, stepData: any) {
    if (!session) return null

    // Fetch current onboarding_data
    const { data: profile, error: fetchError } = await supabase
      .from('profiles')
      .select('onboarding_data')
      .eq('id', session.user.id)
      .single()

    if (fetchError) throw fetchError

    // Merge new step data into existing onboarding_data
    const currentData = profile?.onboarding_data || {}
    const mergedData = {
      ...currentData,
      [stepKey]: stepData,
    }

    // Update only onboarding_data column
    const { error: updateError } = await supabase
      .from('profiles')
      .update({
        onboarding_data: mergedData,
        updated_at: new Date().toISOString(),
      })
      .eq('id', session.user.id)

    if (updateError) throw updateError

    return mergedData
  }

  async function saveStep(stepData: CreatorFormData | BrandFormData, nextStep?: number) {
    if (!session || !role) return

    setLoading(true)
    setError('')

    try {
      // Determine step key based on current step
      const stepKey = `step${currentStep}`

      // Update local state
      if (role === 'creator') {
        const cd = { ...creatorData, ...stepData } as CreatorFormData
        setCreatorData(cd)
      } else {
        const bd = { ...brandData, ...stepData } as BrandFormData
        setBrandData(bd)
      }

      // Save to onboarding_data JSON (merge)
      await mergeOnboardingData(stepKey, stepData)

      if (nextStep) {
        setCurrentStep(nextStep)
      }
    } catch (err: any) {
      setError(err.message || 'Có lỗi xảy ra khi lưu dữ liệu')
    } finally {
      setLoading(false)
    }
  }

  async function handleComplete() {
    if (!session || !role) return

    setLoading(true)
    setError('')

    try {
      // Fetch onboarding_data
      const { data: profile, error: fetchError } = await supabase
        .from('profiles')
        .select('onboarding_data')
        .eq('id', session.user.id)
        .single()

      if (fetchError) throw fetchError

      const onboardingData = profile?.onboarding_data || {}

      // Map onboarding_data to profile columns
      const updateData: any = {
        onboarding_completed: true,
        updated_at: new Date().toISOString(),
      }

      if (role === 'creator') {
        const step2 = onboardingData.step2 || {}
        const step3 = onboardingData.step3 || {}
        const step4 = onboardingData.step4 || {}

        updateData.display_name = step2.display_name || null
        updateData.country = step2.country || null
        updateData.city = step2.city || null
        updateData.birth_year = step2.birth_year || null
        updateData.creator_platforms = step3.creator_platforms || null
        updateData.followers_count = step3.followers_count || null
        updateData.avg_views = step3.avg_views || null
        updateData.content_categories = step3.content_categories || null
        updateData.collaboration_expectation = step4.collaboration_expectation || null
      } else {
        const step2 = onboardingData.step2 || {}
        const step3 = onboardingData.step3 || {}
        const step4 = onboardingData.step4 || {}

        updateData.brand_name = step2.company_name || null
        updateData.industry = step2.industry || null
        updateData.country = step2.country || null
        updateData.city = step2.city || null
        updateData.company_size = step3.company_size || null
        // monthly_marketing_budget must be NUMERIC (convert to number)
        const budgetValue = step3.budget || step3.campaign_budget_range
        updateData.monthly_marketing_budget = budgetValue ? (typeof budgetValue === 'string' ? parseFloat(budgetValue.replace(/[^0-9.]/g, '')) || null : Number(budgetValue)) : null
        updateData.target_platforms = step3.target_platforms || null
        // collaboration_goal must be TEXT[] (array), convert string to array if needed
        const goalValue = step4.campaign_goal || step4.collaboration_goal
        updateData.collaboration_goal = Array.isArray(goalValue) ? goalValue : (goalValue ? [goalValue] : null)
      }

      // Update profile columns and set onboarding_completed = true
      const { error } = await supabase
        .from('profiles')
        .update(updateData)
        .eq('id', session.user.id)

      if (error) throw error

      // Redirect to /app - AppGate will handle routing
      navigate('/app', { replace: true })
    } catch (err: any) {
      setError(err.message || 'Có lỗi xảy ra khi hoàn tất onboarding')
      setLoading(false)
    }
  }

  if (!role) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-[#6B7280]">Đang tải...</div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#EEF1FF] via-[#F5F7FF] to-white py-20 px-6 pt-24">
      <div className="max-w-3xl mx-auto">
        <div className="bg-white/90 backdrop-blur-xl rounded-3xl p-8 md:p-10 shadow-xl border border-black/5">
          {/* Progress indicator */}
          <div className="mb-8">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm text-[#6B7280]">
                Bước {currentStep} / 5
              </span>
              <span className="text-sm text-[#6B7280]">
                {Math.round((currentStep / 5) * 100)}%
              </span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div
                className="bg-gradient-to-r from-[#6366F1] to-[#EC4899] h-2 rounded-full transition-all"
                style={{ width: `${(currentStep / 5) * 100}%` }}
              />
            </div>
          </div>

          {error && (
            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
              {error}
            </div>
          )}

          {/* Step 2: Basic Identity */}
          {currentStep === 2 && (
            <Step2BasicIdentity
              role={role}
              creatorData={creatorData}
              brandData={brandData}
              onSave={(data) => saveStep(data, 3)}
              loading={loading}
            />
          )}

          {/* Step 3: Business/Creator Metrics */}
          {currentStep === 3 && (
            <Step3Metrics
              role={role}
              creatorData={creatorData}
              brandData={brandData}
              onSave={(data) => saveStep(data, 4)}
              loading={loading}
            />
          )}

          {/* Step 4: Collaboration Intent */}
          {currentStep === 4 && (
            <Step4Collaboration
              role={role}
              creatorData={creatorData}
              brandData={brandData}
              onSave={(data) => saveStep(data, 5)}
              loading={loading}
            />
          )}

          {/* Step 5: Finalize */}
          {currentStep === 5 && (
            <Step5Finalize
              role={role}
              creatorData={creatorData}
              brandData={brandData}
              onComplete={handleComplete}
              loading={loading}
            />
          )}

          {/* Navigation buttons */}
          {currentStep > 2 && (
            <div className="mt-6 flex justify-between">
              <button
                onClick={() => setCurrentStep(currentStep - 1)}
                disabled={loading}
                className="px-6 py-2.5 rounded-xl font-medium text-[#6B7280] border border-gray-300 hover:bg-gray-50 disabled:opacity-50"
              >
                Quay lại
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

// Step 2: Basic Identity
function Step2BasicIdentity({
  role,
  creatorData,
  brandData,
  onSave,
  loading,
}: {
  role: 'creator' | 'brand'
  creatorData: CreatorFormData
  brandData: BrandFormData
  onSave: (data: CreatorFormData | BrandFormData) => void
  loading: boolean
}) {
  const [localData, setLocalData] = useState(
    role === 'creator'
      ? {
          display_name: creatorData.display_name || '',
          country: creatorData.country || '',
          city: creatorData.city || '',
          birth_year: creatorData.birth_year || undefined,
        }
      : {
          company_name: brandData.company_name || '',
          industry: brandData.industry || '',
          country: brandData.country || '',
          city: brandData.city || '',
        }
  )

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (role === 'creator') {
      onSave({
        display_name: localData.display_name,
        country: localData.country,
        city: localData.city,
        birth_year: localData.birth_year,
      } as CreatorFormData)
    } else {
      onSave({
        company_name: localData.company_name,
        industry: localData.industry,
        country: localData.country,
        city: localData.city,
      } as BrandFormData)
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <h1 className="text-3xl font-semibold tracking-tight mb-4">
        Thông tin cơ bản
      </h1>
      <p className="text-[#6B7280] mb-8">
        {role === 'creator' ? 'Hãy cho chúng tôi biết về bạn' : 'Hãy cho chúng tôi biết về thương hiệu của bạn'}
      </p>

      <div className="space-y-4">
        {role === 'creator' ? (
          <>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Tên hiển thị *
              </label>
              <input
                type="text"
                value={localData.display_name}
                onChange={(e) => setLocalData({ ...localData, display_name: e.target.value } as any)}
                className="w-full px-4 py-2.5 border rounded-lg"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Quốc gia *
              </label>
              <input
                type="text"
                value={localData.country}
                onChange={(e) => setLocalData({ ...localData, country: e.target.value })}
                className="w-full px-4 py-2.5 border rounded-lg"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Thành phố *
              </label>
              <input
                type="text"
                value={localData.city}
                onChange={(e) => setLocalData({ ...localData, city: e.target.value })}
                className="w-full px-4 py-2.5 border rounded-lg"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Năm sinh
              </label>
              <input
                type="number"
                min="1950"
                max={new Date().getFullYear()}
                value={localData.birth_year || ''}
                onChange={(e) => setLocalData({ ...localData, birth_year: e.target.value ? parseInt(e.target.value) : undefined } as any)}
                className="w-full px-4 py-2.5 border rounded-lg"
              />
            </div>
          </>
        ) : (
          <>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Tên công ty *
              </label>
              <input
                type="text"
                value={localData.company_name}
                onChange={(e) => setLocalData({ ...localData, company_name: e.target.value } as any)}
                className="w-full px-4 py-2.5 border rounded-lg"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Ngành nghề *
              </label>
              <input
                type="text"
                value={localData.industry}
                onChange={(e) => setLocalData({ ...localData, industry: e.target.value } as any)}
                className="w-full px-4 py-2.5 border rounded-lg"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Quốc gia *
              </label>
              <input
                type="text"
                value={localData.country}
                onChange={(e) => setLocalData({ ...localData, country: e.target.value })}
                className="w-full px-4 py-2.5 border rounded-lg"
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Thành phố *
              </label>
              <input
                type="text"
                value={localData.city}
                onChange={(e) => setLocalData({ ...localData, city: e.target.value })}
                className="w-full px-4 py-2.5 border rounded-lg"
                required
              />
            </div>
          </>
        )}

        <button
          type="submit"
          disabled={loading}
          className="w-full px-6 py-2.5 rounded-xl font-medium text-white bg-gradient-to-r from-[#6366F1] to-[#EC4899] disabled:opacity-50"
        >
          {loading ? 'Đang lưu...' : 'Tiếp tục'}
        </button>
      </div>
    </form>
  )
}

// Step 3: Business/Creator Metrics
function Step3Metrics({
  role,
  creatorData,
  brandData,
  onSave,
  loading,
}: {
  role: 'creator' | 'brand'
  creatorData: CreatorFormData
  brandData: BrandFormData
  onSave: (data: CreatorFormData | BrandFormData) => void
  loading: boolean
}) {
  const platforms = ['TikTok', 'Instagram', 'YouTube', 'Facebook', 'Twitter', 'LinkedIn']
  
  const [localData, setLocalData] = useState(
    role === 'creator'
      ? {
          creator_platforms: creatorData.creator_platforms || [],
          followers_count: creatorData.followers_count || undefined,
          avg_views: creatorData.avg_views || undefined,
          content_categories: creatorData.content_categories || [],
        }
      : {
          company_size: brandData.company_size || '',
          budget: brandData.budget || undefined,
          campaign_budget_range: brandData.campaign_budget_range || '',
          target_platforms: brandData.target_platforms || [],
        }
  )

  const togglePlatform = (platform: string, type: 'creator' | 'target') => {
    if (type === 'creator') {
      const current = localData.creator_platforms || []
      const updated = current.includes(platform)
        ? current.filter((p) => p !== platform)
        : [...current, platform]
      setLocalData({ ...localData, creator_platforms: updated } as any)
    } else {
      const current = localData.target_platforms || []
      const updated = current.includes(platform)
        ? current.filter((p) => p !== platform)
        : [...current, platform]
      setLocalData({ ...localData, target_platforms: updated } as any)
    }
  }

  const toggleCategory = (category: string) => {
    const current = localData.content_categories || []
    const updated = current.includes(category)
      ? current.filter((c) => c !== category)
      : [...current, category]
      setLocalData({ ...localData, content_categories: updated } as any)
  }

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (role === 'creator') {
      onSave({
        creator_platforms: localData.creator_platforms,
        followers_count: localData.followers_count,
        avg_views: localData.avg_views,
        content_categories: localData.content_categories,
      } as CreatorFormData)
    } else {
      onSave({
        company_size: localData.company_size,
        budget: localData.budget,
        campaign_budget_range: localData.campaign_budget_range,
        target_platforms: localData.target_platforms,
      } as BrandFormData)
    }
  }

  const categories = ['Beauty', 'Fashion', 'Food', 'Travel', 'Tech', 'Fitness', 'Lifestyle', 'Education']

  return (
    <form onSubmit={handleSubmit}>
      <h1 className="text-3xl font-semibold tracking-tight mb-4">
        {role === 'creator' ? 'Thông tin Creator' : 'Thông tin Brand'}
      </h1>
      <p className="text-[#6B7280] mb-8">
        {role === 'creator' ? 'Chia sẻ về kênh và nội dung của bạn' : 'Chia sẻ về quy mô và ngân sách marketing'}
      </p>

      <div className="space-y-4">
        {role === 'creator' ? (
          <>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Nền tảng bạn sử dụng *
              </label>
              <div className="grid grid-cols-2 gap-2">
                {platforms.map((platform) => (
                  <button
                    key={platform}
                    type="button"
                    onClick={() => togglePlatform(platform, 'creator')}
                    className={`px-4 py-2 rounded-lg border text-sm ${
                      localData.creator_platforms?.includes(platform)
                        ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                        : 'border-gray-300 hover:border-gray-400'
                    }`}
                  >
                    {platform}
                  </button>
                ))}
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Số lượng người theo dõi
              </label>
              <input
                type="number"
                min="0"
                value={localData.followers_count || ''}
                onChange={(e) => setLocalData({ ...localData, followers_count: e.target.value ? parseInt(e.target.value) : undefined } as any)}
                className="w-full px-4 py-2.5 border rounded-lg"
                placeholder="Ví dụ: 100000"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Lượt xem trung bình
              </label>
              <input
                type="number"
                min="0"
                value={localData.avg_views || ''}
                onChange={(e) => setLocalData({ ...localData, avg_views: e.target.value ? parseInt(e.target.value) : undefined } as any)}
                className="w-full px-4 py-2.5 border rounded-lg"
                placeholder="Ví dụ: 50000"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Danh mục nội dung
              </label>
              <div className="grid grid-cols-2 gap-2">
                {categories.map((category) => (
                  <button
                    key={category}
                    type="button"
                    onClick={() => toggleCategory(category)}
                    className={`px-4 py-2 rounded-lg border text-sm ${
                      localData.content_categories?.includes(category)
                        ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                        : 'border-gray-300 hover:border-gray-400'
                    }`}
                  >
                    {category}
                  </button>
                ))}
              </div>
            </div>
          </>
        ) : (
          <>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Quy mô công ty *
              </label>
              <select
                value={localData.company_size}
                onChange={(e) => setLocalData({ ...localData, company_size: e.target.value } as any)}
                className="w-full px-4 py-2.5 border rounded-lg"
                required
              >
                <option value="">Chọn quy mô</option>
                <option value="startup">Startup (1-10 nhân viên)</option>
                <option value="small">Nhỏ (11-50 nhân viên)</option>
                <option value="medium">Vừa (51-200 nhân viên)</option>
                <option value="large">Lớn (201-1000 nhân viên)</option>
                <option value="enterprise">Doanh nghiệp (1000+ nhân viên)</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Ngân sách marketing (USD)
              </label>
              <input
                type="number"
                min="0"
                value={localData.budget || ''}
                onChange={(e) => setLocalData({ ...localData, budget: e.target.value ? parseInt(e.target.value) : undefined } as any)}
                className="w-full px-4 py-2.5 border rounded-lg"
                placeholder="Ví dụ: 5000"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Khoảng ngân sách chiến dịch
              </label>
              <input
                type="text"
                value={localData.campaign_budget_range}
                onChange={(e) => setLocalData({ ...localData, campaign_budget_range: e.target.value } as any)}
                className="w-full px-4 py-2.5 border rounded-lg"
                placeholder="Ví dụ: $1000 - $5000"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Nền tảng mục tiêu *
              </label>
              <div className="grid grid-cols-2 gap-2">
                {platforms.map((platform) => (
                  <button
                    key={platform}
                    type="button"
                    onClick={() => togglePlatform(platform, 'target')}
                    className={`px-4 py-2 rounded-lg border text-sm ${
                      localData.target_platforms?.includes(platform)
                        ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                        : 'border-gray-300 hover:border-gray-400'
                    }`}
                  >
                    {platform}
                  </button>
                ))}
              </div>
            </div>
          </>
        )}

        <button
          type="submit"
          disabled={loading}
          className="w-full px-6 py-2.5 rounded-xl font-medium text-white bg-gradient-to-r from-[#6366F1] to-[#EC4899] disabled:opacity-50"
        >
          {loading ? 'Đang lưu...' : 'Tiếp tục'}
        </button>
      </div>
    </form>
  )
}

// Step 4: Collaboration Intent
function Step4Collaboration({
  role,
  creatorData,
  brandData,
  onSave,
  loading,
}: {
  role: 'creator' | 'brand'
  creatorData: CreatorFormData
  brandData: BrandFormData
  onSave: (data: CreatorFormData | BrandFormData) => void
  loading: boolean
}) {
  const collaborationTypes: ('paid' | 'gift' | 'affiliate')[] = ['paid', 'gift', 'affiliate']
  
  const [localData, setLocalData] = useState(
    role === 'creator'
      ? {
          collaboration_expectation: creatorData.collaboration_expectation || [],
        }
      : {
          campaign_goal: brandData.campaign_goal || '',
          preferred_collaboration_type: brandData.preferred_collaboration_type || [],
        }
  )

  const toggleCollaborationType = (type: 'paid' | 'gift' | 'affiliate') => {
    if (role === 'creator') {
      const current = localData.collaboration_expectation || []
      const updated = current.includes(type)
        ? current.filter((t) => t !== type)
        : [...current, type]
      setLocalData({ ...localData, collaboration_expectation: updated } as any)
    } else {
      const current = localData.preferred_collaboration_type || []
      const updated = current.includes(type)
        ? current.filter((t) => t !== type)
        : [...current, type]
      setLocalData({ ...localData, preferred_collaboration_type: updated } as any)
    }
  }

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    if (role === 'creator') {
      onSave({
        collaboration_expectation: localData.collaboration_expectation,
      } as CreatorFormData)
    } else {
      onSave({
        campaign_goal: localData.campaign_goal,
        preferred_collaboration_type: localData.preferred_collaboration_type,
      } as BrandFormData)
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <h1 className="text-3xl font-semibold tracking-tight mb-4">
        Mục tiêu hợp tác
      </h1>
      <p className="text-[#6B7280] mb-8">
        {role === 'creator' ? 'Bạn mong đợi gì từ các hợp tác?' : 'Mục tiêu hợp tác của thương hiệu là gì?'}
      </p>

      <div className="space-y-4">
        {role === 'creator' ? (
          <>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Loại hợp tác mong muốn *
              </label>
              <div className="grid grid-cols-3 gap-2">
                {collaborationTypes.map((type) => (
                  <button
                    key={type}
                    type="button"
                    onClick={() => toggleCollaborationType(type)}
                    className={`px-4 py-2 rounded-lg border text-sm ${
                      localData.collaboration_expectation?.includes(type)
                        ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                        : 'border-gray-300 hover:border-gray-400'
                    }`}
                  >
                    {type === 'paid' ? 'Trả phí' : type === 'gift' ? 'Quà tặng' : 'Affiliate'}
                  </button>
                ))}
              </div>
            </div>
          </>
        ) : (
          <>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Mục tiêu chiến dịch *
              </label>
              <textarea
                value={localData.campaign_goal}
                onChange={(e) => setLocalData({ ...localData, campaign_goal: e.target.value } as any)}
                rows={5}
                className="w-full px-4 py-2.5 border rounded-lg"
                placeholder="Mô tả mục tiêu hợp tác của thương hiệu..."
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Loại hợp tác ưa thích *
              </label>
              <div className="grid grid-cols-3 gap-2">
                {collaborationTypes.map((type) => (
                  <button
                    key={type}
                    type="button"
                    onClick={() => toggleCollaborationType(type)}
                    className={`px-4 py-2 rounded-lg border text-sm ${
                      localData.preferred_collaboration_type?.includes(type)
                        ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                        : 'border-gray-300 hover:border-gray-400'
                    }`}
                  >
                    {type === 'paid' ? 'Trả phí' : type === 'gift' ? 'Quà tặng' : 'Affiliate'}
                  </button>
                ))}
              </div>
            </div>
          </>
        )}

        <button
          type="submit"
          disabled={loading}
          className="w-full px-6 py-2.5 rounded-xl font-medium text-white bg-gradient-to-r from-[#6366F1] to-[#EC4899] disabled:opacity-50"
        >
          {loading ? 'Đang lưu...' : 'Tiếp tục'}
        </button>
      </div>
    </form>
  )
}

// Step 5: Finalize
function Step5Finalize({
  role,
  creatorData,
  brandData,
  onComplete,
  loading,
}: {
  role: 'creator' | 'brand'
  creatorData: CreatorFormData
  brandData: BrandFormData
  onComplete: () => void
  loading: boolean
}) {
  return (
    <div>
      <h1 className="text-3xl font-semibold tracking-tight mb-4">
        Hoàn tất thiết lập
      </h1>
      <p className="text-[#6B7280] mb-8">
        Bạn đã hoàn thành tất cả các bước thiết lập. Nhấn "Hoàn tất" để bắt đầu sử dụng ALINO.
      </p>

      <div className="bg-gray-50 rounded-lg p-4 mb-6">
        <h3 className="font-medium mb-2">Tóm tắt thông tin:</h3>
        <ul className="text-sm text-[#6B7280] space-y-1">
          {role === 'creator' && (
            <>
              <li>• Tên: {creatorData.display_name || 'Chưa có'}</li>
              <li>• Địa điểm: {creatorData.city && creatorData.country ? `${creatorData.city}, ${creatorData.country}` : 'Chưa có'}</li>
              <li>• Nền tảng: {creatorData.creator_platforms?.length || 0} nền tảng</li>
            </>
          )}
          {role === 'brand' && (
            <>
              <li>• Công ty: {brandData.company_name || 'Chưa có'}</li>
              <li>• Ngành: {brandData.industry || 'Chưa có'}</li>
              <li>• Quy mô: {brandData.company_size || 'Chưa có'}</li>
            </>
          )}
        </ul>
      </div>

      <button
        onClick={onComplete}
        disabled={loading}
        className="w-full px-6 py-2.5 rounded-xl font-medium text-white bg-gradient-to-r from-[#6366F1] to-[#EC4899] disabled:opacity-50"
      >
        {loading ? 'Đang xử lý...' : 'Hoàn tất'}
      </button>
    </div>
  )
}
</file>

<file path="src/pages/ProfilePage.tsx">
import { useState, useEffect, useRef } from 'react'
import { useAuth } from '../hooks/useAuth'
import { useProfile } from '../hooks/useProfile'
import { getSupabase } from '../lib/supabase'
import type { Profile, CreatorProfile, BrandProfile } from '../types/profile'
import AvatarUpload from '../components/AvatarUpload'
import Toast from '../components/Toast'

export default function ProfilePage() {
  const { session, isAuthenticated } = useAuth()
  const { profile, loading: profileLoading } = useProfile(session?.user?.id, isAuthenticated)
  const [loading, setLoading] = useState(false)
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' } | null>(null)
  const [fieldErrors, setFieldErrors] = useState<Record<string, string>>({})
  const supabase = getSupabase()
  
  // Refs for field focus/scroll
  const fieldRefs = useRef<Record<string, HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement | null>>({})

  // Form state - matches FINAL schema exactly
  interface ProfileFormData {
    // Core fields
    display_name?: string | null
    avatar_url?: string | null
    bio?: string | null
    birth_year?: number | null
    country?: string | null
    city?: string | null
    // Creator fields
    creator_platforms?: string[] | null // TEXT[]
    content_categories?: string[] | null // TEXT[]
    followers_count?: number | null
    avg_views?: number | null
    collaboration_expectation?: string[] | null // TEXT[]
    // Brand fields
    brand_name?: string | null
    industry?: string | null
    company_size?: string | null
    monthly_marketing_budget?: number | null // NUMERIC
    target_platforms?: string[] | null // TEXT[]
    collaboration_goal?: string[] | null // TEXT[]
  }
  const [formData, setFormData] = useState<ProfileFormData>({})

  useEffect(() => {
    if (profile) {
      // Load all fields directly from profile columns (matches FINAL schema)
      setFormData({
        display_name: profile.display_name || undefined,
        avatar_url: profile.avatar_url || undefined,
        bio: profile.bio || undefined,
        birth_year: profile.birth_year || undefined,
        country: profile.country || undefined,
        city: profile.city || undefined,
        // Creator fields
        creator_platforms: (profile as any).creator_platforms || undefined,
        content_categories: (profile as any).content_categories || undefined,
        followers_count: (profile as any).followers_count || undefined,
        avg_views: (profile as any).avg_views || undefined,
        collaboration_expectation: (profile as any).collaboration_expectation || undefined,
        // Brand fields
        brand_name: (profile as any).brand_name || undefined,
        industry: (profile as any).industry || undefined,
        company_size: (profile as any).company_size || undefined,
        monthly_marketing_budget: (profile as any).monthly_marketing_budget ? Number((profile as any).monthly_marketing_budget) : undefined,
        target_platforms: (profile as any).target_platforms || undefined,
        collaboration_goal: Array.isArray((profile as any).collaboration_goal) ? (profile as any).collaboration_goal : undefined,
      })
    }
  }, [profile])

  if (profileLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center pt-24">
        <div className="text-[#6B7280]">Đang tải...</div>
      </div>
    )
  }

  if (!profile) {
    return (
      <div className="min-h-screen flex items-center justify-center pt-24">
        <div className="text-[#6B7280]">Không tìm thấy hồ sơ</div>
      </div>
    )
  }

  const role = profile.role || 'creator'

  // Validation function
  const validateProfile = (): { isValid: boolean; firstInvalidField: string | null } => {
    const errors: Record<string, string> = {}

    // Core required fields
    if (!formData.display_name || formData.display_name.trim() === '') {
      errors.display_name = 'Vui lòng nhập tên hiển thị'
    }
    if (!formData.birth_year) {
      errors.birth_year = 'Vui lòng nhập năm sinh'
    }
    if (!formData.country || formData.country.trim() === '') {
      errors.country = 'Vui lòng nhập quốc gia'
    }
    if (!formData.city || formData.city.trim() === '') {
      errors.city = 'Vui lòng nhập thành phố'
    }

    if (role === 'creator') {
      // Creator required fields
      if (!formData.creator_platforms || formData.creator_platforms.length === 0) {
        errors.creator_platforms = 'Vui lòng chọn ít nhất một nền tảng'
      }
      if (!formData.content_categories || formData.content_categories.length === 0) {
        errors.content_categories = 'Vui lòng chọn ít nhất một danh mục nội dung'
      }
      if (!formData.collaboration_expectation || formData.collaboration_expectation.length === 0) {
        errors.collaboration_expectation = 'Vui lòng chọn ít nhất một kỳ vọng hợp tác'
      }
      if (!formData.followers_count || formData.followers_count <= 0) {
        errors.followers_count = 'Vui lòng nhập số lượng người theo dõi (lớn hơn 0)'
      }
      if (!formData.avg_views || formData.avg_views <= 0) {
        errors.avg_views = 'Vui lòng nhập lượt xem trung bình (lớn hơn 0)'
      }
    } else {
      // Brand required fields
      if (!formData.brand_name || formData.brand_name.trim() === '') {
        errors.brand_name = 'Vui lòng nhập tên công ty'
      }
      if (!formData.industry || formData.industry.trim() === '') {
        errors.industry = 'Vui lòng nhập ngành nghề'
      }
      if (!formData.company_size || formData.company_size.trim() === '') {
        errors.company_size = 'Vui lòng chọn quy mô công ty'
      }
      if (!formData.monthly_marketing_budget || formData.monthly_marketing_budget <= 0) {
        errors.monthly_marketing_budget = 'Vui lòng nhập ngân sách marketing (lớn hơn 0)'
      }
      if (!formData.target_platforms || formData.target_platforms.length === 0) {
        errors.target_platforms = 'Vui lòng chọn ít nhất một nền tảng mục tiêu'
      }
      if (!formData.collaboration_goal || formData.collaboration_goal.length === 0) {
        errors.collaboration_goal = 'Vui lòng chọn ít nhất một mục tiêu hợp tác'
      }
    }

    setFieldErrors(errors)

    if (Object.keys(errors).length > 0) {
      // Find first invalid field for scrolling
      const fieldOrder = role === 'creator'
        ? ['display_name', 'birth_year', 'country', 'city', 'creator_platforms', 'content_categories', 'followers_count', 'avg_views', 'collaboration_expectation']
        : ['display_name', 'birth_year', 'country', 'city', 'brand_name', 'industry', 'company_size', 'monthly_marketing_budget', 'target_platforms', 'collaboration_goal']
      
      const firstInvalidField = fieldOrder.find(field => errors[field]) || null
      return { isValid: false, firstInvalidField }
    }

    return { isValid: true, firstInvalidField: null }
  }

  const scrollToField = (fieldName: string) => {
    const field = fieldRefs.current[fieldName]
    if (field) {
      field.scrollIntoView({ behavior: 'smooth', block: 'center' })
      setTimeout(() => field.focus(), 300)
    }
  }

  const handleSave = async () => {
    if (!session || !profile) return

    // Validate before saving
    const validation = validateProfile()
    if (!validation.isValid) {
      setToast({ message: 'Vui lòng điền đầy đủ thông tin bắt buộc', type: 'error' })
      if (validation.firstInvalidField) {
        scrollToField(validation.firstInvalidField)
      }
      return
    }

    setLoading(true)
    setFieldErrors({})

    try {
      // Build update object with only columns (no onboarding_data)
      const updateData: any = {}

      // Core fields (matches FINAL schema)
      updateData.display_name = formData.display_name || null
      updateData.avatar_url = formData.avatar_url || null
      updateData.bio = formData.bio || null
      updateData.birth_year = formData.birth_year || null
      updateData.country = formData.country || null
      updateData.city = formData.city || null

      if (role === 'creator') {
        // Creator-specific fields (matches FINAL schema - TEXT[] are arrays)
        updateData.creator_platforms = formData.creator_platforms || null
        updateData.content_categories = formData.content_categories || null
        updateData.followers_count = formData.followers_count || null
        updateData.avg_views = formData.avg_views || null
        updateData.collaboration_expectation = formData.collaboration_expectation || null
      } else {
        // Brand-specific fields (matches FINAL schema)
        updateData.brand_name = formData.brand_name || null
        updateData.industry = formData.industry || null
        updateData.company_size = formData.company_size || null
        updateData.monthly_marketing_budget = formData.monthly_marketing_budget !== undefined ? formData.monthly_marketing_budget : null // NUMERIC
        updateData.target_platforms = formData.target_platforms || null
        updateData.collaboration_goal = formData.collaboration_goal || null // TEXT[]
      }

      // Explicitly remove any invalid columns (safety check)
      // These columns do NOT exist in the database schema
      const {
        preferred_collaboration_type,
        success_collaboration_rate,
        company_name,
        website,
        campaign_budget_range,
        campaign_goal,
        target_creator_size,
        contact_person_name,
        contact_person_phone,
        ...safeUpdateData
      } = updateData as any
      
      // Update profile (only with valid columns)
      const { error: profileError } = await supabase
        .from('profiles')
        .update(safeUpdateData)
        .eq('id', session.user.id)

      if (profileError) throw profileError

      // Sync display_name and avatar_url to auth metadata
      const metadataUpdate: Record<string, any> = {}
      if (formData.display_name !== undefined) {
        metadataUpdate.display_name = formData.display_name
      }
      if (formData.avatar_url !== undefined) {
        metadataUpdate.avatar_url = formData.avatar_url
      }

      if (Object.keys(metadataUpdate).length > 0) {
        const { error: authError } = await supabase.auth.updateUser({
          data: metadataUpdate,
        })
        if (authError) {
          console.warn('Failed to update auth metadata:', authError)
          // Don't throw - profile update succeeded
        }
      }

      setToast({ message: 'Lưu hồ sơ thành công', type: 'success' })
    } catch (err: any) {
      console.error('Profile save error:', err)
      setToast({ message: err.message || 'Có lỗi xảy ra, vui lòng thử lại', type: 'error' })
    } finally {
      setLoading(false)
    }
  }

  const handleAvatarChange = async (url: string) => {
    // URL is already a public URL from AvatarUpload component (after successful storage upload)
    if (!session || !profile) {
      console.error('Cannot save avatar: missing session or profile')
      return
    }

    // Optimistically update form state
    setFormData((prev) => ({ ...prev, avatar_url: url }))

    try {
      // Update profiles.avatar_url with public URL (primary source)
      const { error: profileError } = await supabase
        .from('profiles')
        .update({
          avatar_url: url,
          updated_at: new Date().toISOString(),
        })
        .eq('id', session.user.id)

      if (profileError) {
        console.error('Failed to update profiles.avatar_url:', profileError)
        throw profileError
      }

      // Sync to auth metadata (secondary, non-blocking)
      const { error: authError } = await supabase.auth.updateUser({
        data: { avatar_url: url },
      })
      if (authError) {
        console.warn('Failed to sync avatar_url to auth metadata (non-blocking):', authError)
        // Don't throw - profile update succeeded
      }

      setToast({ message: 'Đã lưu avatar thành công', type: 'success' })
    } catch (error: any) {
      console.error('Avatar save error:', error)
      // Revert optimistic update on error
      setFormData((prev) => ({ ...prev, avatar_url: profile.avatar_url || null }))
      setToast({ message: error.message || 'Có lỗi xảy ra khi lưu avatar', type: 'error' })
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#EEF1FF] via-[#F5F7FF] to-white py-20 px-6 pt-24">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white/90 backdrop-blur-xl rounded-3xl p-8 md:p-10 shadow-xl border border-black/5">
          <h1 className="text-3xl font-semibold tracking-tight mb-8">Hồ sơ</h1>

          <form onSubmit={(e) => { e.preventDefault(); handleSave(); }} className="space-y-6">
            {/* Basic Identity Section */}
            <div className="border-b pb-6">
              <h2 className="text-xl font-semibold mb-4">Thông tin cơ bản</h2>
              
              {role === 'creator' ? (
                <>
                  {/* Top Row: Display Name | Avatar */}
                  <div className="flex flex-col md:flex-row gap-6 mb-6 items-start">
                    {/* Left: Display Name */}
                    <div className="flex-1 space-y-4 w-full md:w-auto">
                      <div>
                        <label className="block text-sm font-medium text-[#374151] mb-2">
                          Tên hiển thị *
                        </label>
                        <input
                          ref={(el) => fieldRefs.current.display_name = el}
                          type="text"
                          value={formData.display_name || ''}
                          onChange={(e) => {
                            setFormData({ ...formData, display_name: e.target.value })
                            if (fieldErrors.display_name) {
                              setFieldErrors(prev => {
                                const next = { ...prev }
                                delete next.display_name
                                return next
                              })
                            }
                          }}
                          className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.display_name ? 'border-red-500' : ''}`}
                          placeholder="Nhập tên hiển thị"
                        />
                        {fieldErrors.display_name && (
                          <p className="mt-1 text-sm text-red-600">{fieldErrors.display_name}</p>
                        )}
                      </div>
                    </div>

                    {/* Right: Avatar */}
                    <div className="flex-shrink-0">
                      <AvatarUpload
                        currentAvatarUrl={formData.avatar_url ?? undefined}
                        onAvatarChange={handleAvatarChange}
                        userId={session?.user?.id || ''}
                      />
                    </div>
                  </div>

                  {/* 2-Column Grid: Birth Year | Country + City */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-[#374151] mb-2">
                        Năm sinh *
                      </label>
                      <input
                        ref={(el) => fieldRefs.current.birth_year = el}
                        type="number"
                        min="1950"
                        max={new Date().getFullYear()}
                        value={formData.birth_year || ''}
                        onChange={(e) => {
                          setFormData({ ...formData, birth_year: e.target.value ? parseInt(e.target.value) : undefined })
                          if (fieldErrors.birth_year) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.birth_year
                              return next
                            })
                          }
                        }}
                        className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.birth_year ? 'border-red-500' : ''}`}
                      />
                      {fieldErrors.birth_year && (
                        <p className="mt-1 text-sm text-red-600">{fieldErrors.birth_year}</p>
                      )}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-[#374151] mb-2">
                        Quốc gia *
                      </label>
                      <input
                        ref={(el) => fieldRefs.current.country = el}
                        type="text"
                        value={formData.country || ''}
                        onChange={(e) => {
                          setFormData({ ...formData, country: e.target.value })
                          if (fieldErrors.country) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.country
                              return next
                            })
                          }
                        }}
                        className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.country ? 'border-red-500' : ''}`}
                      />
                      {fieldErrors.country && (
                        <p className="mt-1 text-sm text-red-600">{fieldErrors.country}</p>
                      )}
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-[#374151] mb-2">
                        Thành phố *
                      </label>
                      <input
                        ref={(el) => fieldRefs.current.city = el}
                        type="text"
                        value={formData.city || ''}
                        onChange={(e) => {
                          setFormData({ ...formData, city: e.target.value })
                          if (fieldErrors.city) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.city
                              return next
                            })
                          }
                        }}
                        className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.city ? 'border-red-500' : ''}`}
                      />
                      {fieldErrors.city && (
                        <p className="mt-1 text-sm text-red-600">{fieldErrors.city}</p>
                      )}
                    </div>
                  </div>
                </>
              ) : (
                <>
                  {/* Top Row: Company Name | Avatar */}
                  <div className="flex flex-col md:flex-row gap-6 mb-6 items-start">
                    {/* Left: Company Name */}
                    <div className="flex-1 space-y-4 w-full md:w-auto">
                      <div>
                        <label className="block text-sm font-medium text-[#374151] mb-2">
                          Tên công ty *
                        </label>
                        <input
                          ref={(el) => fieldRefs.current.brand_name = el}
                          type="text"
                          value={formData.brand_name || ''}
                          onChange={(e) => {
                            setFormData({ ...formData, brand_name: e.target.value })
                            if (fieldErrors.brand_name) {
                              setFieldErrors(prev => {
                                const next = { ...prev }
                                delete next.brand_name
                                return next
                              })
                            }
                          }}
                          className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.brand_name ? 'border-red-500' : ''}`}
                          placeholder="Nhập tên công ty"
                        />
                        {fieldErrors.brand_name && (
                          <p className="mt-1 text-sm text-red-600">{fieldErrors.brand_name}</p>
                        )}
                      </div>
                    </div>

                    {/* Right: Avatar */}
                    <div className="flex-shrink-0">
                      <AvatarUpload
                        currentAvatarUrl={formData.avatar_url ?? undefined}
                        onAvatarChange={handleAvatarChange}
                        userId={session?.user?.id || ''}
                      />
                    </div>
                  </div>

                  {/* 2-Column Grid: Industry | Country + City */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-[#374151] mb-2">
                        Ngành nghề *
                      </label>
                      <input
                        ref={(el) => fieldRefs.current.industry = el}
                        type="text"
                        value={formData.industry || ''}
                        onChange={(e) => {
                          setFormData({ ...formData, industry: e.target.value })
                          if (fieldErrors.industry) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.industry
                              return next
                            })
                          }
                        }}
                        className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.industry ? 'border-red-500' : ''}`}
                      />
                      {fieldErrors.industry && (
                        <p className="mt-1 text-sm text-red-600">{fieldErrors.industry}</p>
                      )}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-[#374151] mb-2">
                        Quốc gia *
                      </label>
                      <input
                        ref={(el) => fieldRefs.current.country = el}
                        type="text"
                        value={formData.country || ''}
                        onChange={(e) => {
                          setFormData({ ...formData, country: e.target.value })
                          if (fieldErrors.country) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.country
                              return next
                            })
                          }
                        }}
                        className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.country ? 'border-red-500' : ''}`}
                      />
                      {fieldErrors.country && (
                        <p className="mt-1 text-sm text-red-600">{fieldErrors.country}</p>
                      )}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-[#374151] mb-2">
                        Thành phố *
                      </label>
                      <input
                        ref={(el) => fieldRefs.current.city = el}
                        type="text"
                        value={formData.city || ''}
                        onChange={(e) => {
                          setFormData({ ...formData, city: e.target.value })
                          if (fieldErrors.city) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.city
                              return next
                            })
                          }
                        }}
                        className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.city ? 'border-red-500' : ''}`}
                      />
                      {fieldErrors.city && (
                        <p className="mt-1 text-sm text-red-600">{fieldErrors.city}</p>
                      )}
                    </div>
                  </div>
                </>
              )}
            </div>

            {/* Business/Creator Metrics Section */}
            {role === 'creator' && (
              <div className="border-b pb-6">
                <h2 className="text-xl font-semibold mb-4">Thông tin Creator</h2>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-[#374151] mb-2">
                    Giới thiệu
                  </label>
                  <textarea
                    value={formData.bio || ''}
                    onChange={(e) => setFormData({ ...formData, bio: e.target.value })}
                    rows={3}
                    className="w-full px-4 py-2.5 border rounded-lg"
                    placeholder="Giới thiệu về bản thân..."
                  />
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-[#374151] mb-2">
                    Nền tảng *
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {['TikTok', 'Instagram', 'YouTube', 'Facebook', 'Twitter', 'LinkedIn'].map((platform) => (
                      <button
                        key={platform}
                        type="button"
                        onClick={() => {
                          const current = formData.creator_platforms || []
                          const updated = current.includes(platform)
                            ? current.filter((p) => p !== platform)
                            : [...current, platform]
                          setFormData({ ...formData, creator_platforms: updated })
                          if (fieldErrors.creator_platforms && updated.length > 0) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.creator_platforms
                              return next
                            })
                          }
                        }}
                        className={`px-4 py-2.5 rounded-lg border text-sm font-medium transition-colors h-10 ${
                          formData.creator_platforms?.includes(platform)
                            ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                            : 'border-gray-300 hover:border-gray-400 text-gray-700'
                        }`}
                      >
                        {platform}
                      </button>
                    ))}
                  </div>
                  {fieldErrors.creator_platforms && (
                    <p className="mt-1 text-sm text-red-600">{fieldErrors.creator_platforms}</p>
                  )}
                </div>
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-[#374151] mb-2">
                      Số lượng người theo dõi *
                    </label>
                    <input
                      ref={(el) => fieldRefs.current.followers_count = el}
                      type="number"
                      min="0"
                      value={formData.followers_count || ''}
                      onChange={(e) => {
                        setFormData({ ...formData, followers_count: e.target.value ? parseInt(e.target.value) : undefined })
                        if (fieldErrors.followers_count) {
                          setFieldErrors(prev => {
                            const next = { ...prev }
                            delete next.followers_count
                            return next
                          })
                        }
                      }}
                      className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.followers_count ? 'border-red-500' : ''}`}
                    />
                    {fieldErrors.followers_count && (
                      <p className="mt-1 text-sm text-red-600">{fieldErrors.followers_count}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-[#374151] mb-2">
                      Lượt xem trung bình *
                    </label>
                    <input
                      ref={(el) => fieldRefs.current.avg_views = el}
                      type="number"
                      min="0"
                      value={formData.avg_views || ''}
                      onChange={(e) => {
                        setFormData({ ...formData, avg_views: e.target.value ? parseInt(e.target.value) : undefined })
                        if (fieldErrors.avg_views) {
                          setFieldErrors(prev => {
                            const next = { ...prev }
                            delete next.avg_views
                            return next
                          })
                        }
                      }}
                      className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.avg_views ? 'border-red-500' : ''}`}
                    />
                    {fieldErrors.avg_views && (
                      <p className="mt-1 text-sm text-red-600">{fieldErrors.avg_views}</p>
                    )}
                  </div>
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-[#374151] mb-2">
                    Danh mục nội dung *
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {['Beauty', 'Fashion', 'Food', 'Travel', 'Tech', 'Fitness', 'Lifestyle', 'Education'].map((category) => (
                      <button
                        key={category}
                        type="button"
                        onClick={() => {
                          const current = formData.content_categories || []
                          const updated = current.includes(category)
                            ? current.filter((c) => c !== category)
                            : [...current, category]
                          setFormData({ ...formData, content_categories: updated })
                          if (fieldErrors.content_categories && updated.length > 0) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.content_categories
                              return next
                            })
                          }
                        }}
                        className={`px-4 py-2.5 rounded-lg border text-sm font-medium transition-colors h-10 ${
                          formData.content_categories?.includes(category)
                            ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                            : 'border-gray-300 hover:border-gray-400 text-gray-700'
                        }`}
                      >
                        {category}
                      </button>
                    ))}
                  </div>
                  {fieldErrors.content_categories && (
                    <p className="mt-1 text-sm text-red-600">{fieldErrors.content_categories}</p>
                  )}
                </div>
              </div>
            )}

            {/* Brand Info Section */}
            {role === 'brand' && (
              <div className="border-b pb-6">
                <h2 className="text-xl font-semibold mb-4">Thông tin Brand</h2>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-[#374151] mb-2">
                    Quy mô công ty *
                  </label>
                  <select
                    ref={(el) => fieldRefs.current.company_size = el}
                    value={formData.company_size || ''}
                    onChange={(e) => {
                      setFormData({ ...formData, company_size: e.target.value })
                      if (fieldErrors.company_size) {
                        setFieldErrors(prev => {
                          const next = { ...prev }
                          delete next.company_size
                          return next
                        })
                      }
                    }}
                    className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.company_size ? 'border-red-500' : ''}`}
                  >
                    <option value="">Chọn quy mô</option>
                    <option value="startup">Startup (1-10 nhân viên)</option>
                    <option value="small">Nhỏ (11-50 nhân viên)</option>
                    <option value="medium">Vừa (51-200 nhân viên)</option>
                    <option value="large">Lớn (201-1000 nhân viên)</option>
                    <option value="enterprise">Doanh nghiệp (1000+ nhân viên)</option>
                  </select>
                  {fieldErrors.company_size && (
                    <p className="mt-1 text-sm text-red-600">{fieldErrors.company_size}</p>
                  )}
                </div>
                <div className="mb-4">
                  <div>
                    <label className="block text-sm font-medium text-[#374151] mb-2">
                      Ngân sách marketing hàng tháng *
                    </label>
                    <input
                      ref={(el) => fieldRefs.current.monthly_marketing_budget = el}
                      type="number"
                      min="0"
                      step="0.01"
                      value={formData.monthly_marketing_budget || ''}
                      onChange={(e) => {
                        setFormData({ ...formData, monthly_marketing_budget: e.target.value ? parseFloat(e.target.value) : undefined })
                        if (fieldErrors.monthly_marketing_budget) {
                          setFieldErrors(prev => {
                            const next = { ...prev }
                            delete next.monthly_marketing_budget
                            return next
                          })
                        }
                      }}
                      className={`w-full px-4 py-2.5 border rounded-lg ${fieldErrors.monthly_marketing_budget ? 'border-red-500' : ''}`}
                      placeholder="Ví dụ: 5000"
                    />
                    {fieldErrors.monthly_marketing_budget && (
                      <p className="mt-1 text-sm text-red-600">{fieldErrors.monthly_marketing_budget}</p>
                    )}
                  </div>
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-[#374151] mb-2">
                    Nền tảng mục tiêu *
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {['TikTok', 'Instagram', 'YouTube', 'Facebook', 'Twitter', 'LinkedIn'].map((platform) => (
                      <button
                        key={platform}
                        type="button"
                        onClick={() => {
                          const current = formData.target_platforms || []
                          const updated = current.includes(platform)
                            ? current.filter((p) => p !== platform)
                            : [...current, platform]
                          setFormData({ ...formData, target_platforms: updated })
                          if (fieldErrors.target_platforms && updated.length > 0) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.target_platforms
                              return next
                            })
                          }
                        }}
                        className={`px-4 py-2.5 rounded-lg border text-sm font-medium transition-colors h-10 ${
                          formData.target_platforms?.includes(platform)
                            ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                            : 'border-gray-300 hover:border-gray-400 text-gray-700'
                        }`}
                      >
                        {platform}
                      </button>
                    ))}
                  </div>
                  {fieldErrors.target_platforms && (
                    <p className="mt-1 text-sm text-red-600">{fieldErrors.target_platforms}</p>
                  )}
                </div>
              </div>
            )}

            {/* Collaboration Intent Section */}
            <div className="pb-6">
              <h2 className="text-xl font-semibold mb-4">Mục tiêu hợp tác</h2>
              {role === 'creator' ? (
                <div>
                  <label className="block text-sm font-medium text-[#374151] mb-2">
                    Kỳ vọng hợp tác *
                  </label>
                  <div className="grid grid-cols-3 gap-2">
                    {['paid', 'gift', 'affiliate'].map((type) => (
                      <button
                        key={type}
                        type="button"
                        onClick={() => {
                          const current = formData.collaboration_expectation || []
                          const updated = current.includes(type)
                            ? current.filter((t) => t !== type)
                            : [...current, type]
                          setFormData({ ...formData, collaboration_expectation: updated })
                          if (fieldErrors.collaboration_expectation && updated.length > 0) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.collaboration_expectation
                              return next
                            })
                          }
                        }}
                        className={`px-4 py-2.5 rounded-lg border text-sm font-medium transition-colors h-10 ${
                          formData.collaboration_expectation?.includes(type)
                            ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                            : 'border-gray-300 hover:border-gray-400 text-gray-700'
                        }`}
                      >
                        {type === 'paid' ? 'Trả phí' : type === 'gift' ? 'Quà tặng' : 'Affiliate'}
                      </button>
                    ))}
                  </div>
                  {fieldErrors.collaboration_expectation && (
                    <p className="mt-1 text-sm text-red-600">{fieldErrors.collaboration_expectation}</p>
                  )}
                </div>
              ) : (
                <div>
                  <label className="block text-sm font-medium text-[#374151] mb-2">
                    Mục tiêu hợp tác *
                  </label>
                  <div className="grid grid-cols-2 gap-2">
                    {['brand_awareness', 'sales', 'engagement', 'lead_generation', 'product_launch', 'community_building'].map((goal) => (
                      <button
                        key={goal}
                        type="button"
                        onClick={() => {
                          const current = formData.collaboration_goal || []
                          const updated = current.includes(goal)
                            ? current.filter((g) => g !== goal)
                            : [...current, goal]
                          setFormData({ ...formData, collaboration_goal: updated })
                          if (fieldErrors.collaboration_goal && updated.length > 0) {
                            setFieldErrors(prev => {
                              const next = { ...prev }
                              delete next.collaboration_goal
                              return next
                            })
                          }
                        }}
                        className={`px-4 py-2.5 rounded-lg border text-sm font-medium transition-colors h-10 ${
                          formData.collaboration_goal?.includes(goal)
                            ? 'border-[#6366F1] bg-[#6366F1]/10 text-[#6366F1]'
                            : 'border-gray-300 hover:border-gray-400 text-gray-700'
                        }`}
                      >
                        {goal === 'brand_awareness' ? 'Nhận diện thương hiệu' :
                         goal === 'sales' ? 'Bán hàng' :
                         goal === 'engagement' ? 'Tương tác' :
                         goal === 'lead_generation' ? 'Tạo lead' :
                         goal === 'product_launch' ? 'Ra mắt sản phẩm' :
                         'Xây dựng cộng đồng'}
                      </button>
                    ))}
                  </div>
                  {fieldErrors.collaboration_goal && (
                    <p className="mt-1 text-sm text-red-600">{fieldErrors.collaboration_goal}</p>
                  )}
                </div>
              )}
            </div>

            {/* Email (read-only) */}
            <div className="border-t pt-6">
              <label className="block text-sm font-medium text-[#374151] mb-2">
                Email
              </label>
              <input
                type="email"
                value={session?.user?.email || ''}
                disabled
                className="w-full px-4 py-2.5 border rounded-lg bg-gray-50 text-gray-500"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full px-6 py-2.5 rounded-xl font-medium text-white bg-gradient-to-r from-[#6366F1] to-[#EC4899] disabled:opacity-50"
            >
              {loading ? 'Đang lưu...' : 'Lưu thay đổi'}
            </button>
          </form>
        </div>
      </div>

      {/* Toast Notification */}
      {toast && (
        <Toast
          message={toast.message}
          type={toast.type}
          onClose={() => setToast(null)}
        />
      )}
    </div>
  )
}
</file>

<file path="src/main.tsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)
</file>

<file path="index.html">
<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/logo/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ALINO - Quản lý hợp tác Creator–Brand</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="README.md">
# MVP Codebase

A clean, modern, production-oriented MVP environment built with Next.js, TypeScript, and React.

## Tech Stack

- Node.js (LTS)
- TypeScript (strict mode)
- React
- Next.js (App Router)
- npm

## Getting Started

### Installation

```bash
npm install
```

### Development

```bash
npm run dev
```

This starts the development server at [http://localhost:3000](http://localhost:3000).

### Build

```bash
npm run build
```

### Production

```bash
npm start
```

### Backup

```bash
npm run backup
```

This script:
1. Runs repomix to bundle the entire codebase
2. Commits the repomix output
3. Pushes to the connected GitHub repository

## Project Structure

- `app/` - UI components and routes (Next.js App Router)
- `core/` - Domain models, types, and business logic
- `infra/` - Backend integration, auth, and external services
- `lib/` - Shared utilities and helpers
- `scripts/` - Build and utility scripts
- `public/` - Static assets

## Environment Variables

Copy `.env.example` to `.env.local` and fill in your values. Never commit `.env.local` or any files containing secrets.

## TypeScript

The project uses TypeScript in strict mode with absolute imports:
- `@/app` - App directory
- `@/core` - Core business logic
- `@/infra` - Infrastructure code
- `@/lib` - Shared utilities
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: ["./index.html", "./src/**/*.{js,ts,jsx,tsx}"],
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif'],
      },
      colors: {
        background: '#FFFFFF',
        foreground: '#0A0A0A',
        border: '#E5E7EB',
      },
    },
  },
  plugins: [],
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    host: true,
    port: 3000,
  },
})
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "types": ["vite/client"],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"],
  "exclude": ["node_modules"]
}
</file>

<file path="src/index.css">
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  * {
    @apply border-border;
  }
  
  body {
    @apply bg-background text-foreground;
    font-family: 'Inter', system-ui, sans-serif;
  }
}

.underline-gradient {
  position: relative;
}

.underline-gradient::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 0;
  width: 0;
  height: 2px;
  background: linear-gradient(90deg, #6366F1, #EC4899);
  transition: width 0.3s ease;
}

.underline-gradient:hover::after {
  width: 100%;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
</file>

<file path=".env.example">
VITE_SUPABASE_URL=https://iralrlsuxoqbgcjzdpbb.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyYWxybHN1eG9xYmdjanpkcGJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1ODA5ODUsImV4cCI6MjA4MjE1Njk4NX0.e0x5keoaE0GlXehvTA05LlzGhZWh63FHROkAz9kPqZU
</file>

<file path=".gitignore">
# =====================
# Dependencies
# =====================
node_modules/
.pnp
.pnp.js

# =====================
# Next.js / Build
# =====================
.next/
out/
build/
dist/

# =====================
# Environment variables
# =====================
.env
.env.local
.env.*.local

# =====================
# Logs
# =====================
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# =====================
# OS / Editor
# =====================
.DS_Store

# =====================
# TypeScript
# =====================
*.tsbuildinfo
next-env.d.ts

# =====================
# Repomix (local only)
# =====================
repomix-output.*

# =====================
# MS Office temp files
# =====================
~$*.docx
~$*.xlsx
~$*.pptx
</file>

<file path="src/App.tsx">
import { BrowserRouter, useLocation } from 'react-router-dom'
import { Router } from './router'
import ScrollToTop from './components/ScrollToTop'
import Header from './components/layout/Header'
import Footer from './components/layout/Footer'

function AppContent() {
  const location = useLocation()
  
  // Check if we're in dashboard mode - hide Footer
  const isDashboardMode = location.pathname.startsWith('/dashboard') || 
                          location.pathname.startsWith('/profile') ||
                          location.pathname.startsWith('/settings')
  
  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-1">
        <Router />
      </main>
      {!isDashboardMode && <Footer />}
    </div>
  )
}

function App() {
  return (
    <BrowserRouter>
      <ScrollToTop />
      <AppContent />
    </BrowserRouter>
  )
}

export default App
</file>

<file path="package.json">
{
  "name": "alino-vite",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "backup": "git add -A && git commit -m \"backup\" || echo \"No changes to commit\" && git push"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.89.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.26.0",
    "react-icons": "^5.5.0",
    "react-easy-crop": "^5.0.5"
  },
  "devDependencies": {
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "@vitejs/plugin-react": "^4.3.1",
    "autoprefixer": "^10.4.23",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.5.4",
    "vite": "^5.4.0"
  }
}
</file>

</files>
